<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta 파트너센터 - 예약 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 기본 스타일 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }

        /* 사이드바 */
        .sidebar { width: 250px; background-color: #ff6900; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-area { padding: 25px 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; background-color: #ff6900; }
        
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-item { padding: 18px 25px; color: white; text-decoration: none; display: flex; align-items: center; transition: 0.2s; cursor: pointer; font-size: 16px; font-weight: 500; }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; }
        .menu-item:hover { background-color: #e65c00; }
        .menu-item.active { background-color: #cc5200; font-weight: bold; border-left: none; }

        /* 메인 컨텐츠 */
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .content-container { max-width: 1400px; margin: 0 auto; }

        .page-title { font-size: 26px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .page-desc { font-size: 14px; color: #666; margin-bottom: 30px; }

        .card { background: white; border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* 캘린더 스타일 */
        .weekly-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .weekly-title { font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        
        .date-controls { display: flex; align-items: center; gap: 10px; }
        .btn-today { background-color: #fff; border: 1px solid #ccc; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-today:hover { background-color: #f0f0f0; border-color: #bbb; }
        
        .calendar-picker-wrapper { position: relative; display: flex; align-items: center; }
        .calendar-icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #555; padding: 5px; transition: color 0.2s; }
        .calendar-icon-btn:hover { color: #ff6900; }
        #date-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        .slider-wrapper { display: flex; align-items: center; justify-content: space-between; gap: 15px; background-color: #fff; }
        .nav-arrow { width: 40px; height: 120px; border: 1px solid #eee; background-color: #fff; border-radius: 4px; cursor: pointer; color: #888; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-top: 0; }
        .nav-arrow:hover { background-color: #f9f9f9; color: #ff6900; border-color: #ff6900; }

        .date-view-window { flex-grow: 1; overflow: hidden; padding-top: 10px; padding-bottom: 10px; }
        .date-container { display: flex; gap: 10px; width: 100%; }

        /* 날짜 박스 디자인 */
        .date-box { 
            flex: 1; 
            border: 1px solid #e0e0e0; 
            border-radius: 2px; 
            background: white; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s; 
            min-width: 0; 
            display: flex;
            flex-direction: column;
            height: 120px;
        }
        .date-box:hover { border-color: #ff6900; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .date-box.active { border: 2px solid #00c4c4; background-color: #fff; }

        /* 날짜 헤더 */
        .box-header { text-align: center; padding: 15px 0 10px 0; border-bottom: 1px solid #eee; }
        .year-month { font-size: 0.75rem; color: #666; margin-bottom: 4px; }
        .date-row { font-size: 1.2rem; font-weight: bold; color: #333; }
        .day-str { font-size: 1rem; margin-left: 2px; }

        /* 요일 색상 */
        .date-box.sun .date-row { color: #e53935; } 
        .date-box.sat .date-row { color: #1e88e5; } 

        /* 오늘 뱃지 */
        .today-badge { 
            position: absolute; top: 10px; right: 10px; 
            background-color: #e3f2fd; color: #1e88e5; 
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; 
            font-weight: bold; display: none; 
        }
        .date-box.is-today .today-badge { display: block; }

        /* 카운트 영역 (숙박만 표시) */
        .box-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 15px;
            font-size: 0.85rem;
        }
        .count-row { display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; }
        .label.stay { color: #333; font-weight: bold; font-size: 1rem; } 
        .val-stay { color: #1e88e5; font-weight: bold; font-size: 1.2rem; }

        /* 검색/테이블 스타일 */
        .search-filter { border: 1px solid #eee; }
        .filter-summary { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 15px; border-radius: 4px; }
        .status-tabs button { padding: 8px 16px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.9rem; margin-right: -1px; }
        .status-tabs button.active { background-color: #ff6900; color: white; border-color: #ff6900; }
        .status-tabs button:first-child { border-radius: 4px 0 0 4px; }
        .status-tabs button:last-child { border-radius: 0 4px 4px 0; }

        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .summary-text { font-size: 0.9rem; font-weight: bold; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; border-top: 2px solid #ddd; }
        .data-table th { background-color: #f5f5f5; padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; }
        .data-table td { padding: 15px 12px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }

        .room-type { font-weight: bold; display: block; }
        .stay-info { font-size: 0.8rem; color: #ff6900; }
        
        .request-text { font-size: 0.85rem; color: #555; text-align: left; max-width: 150px; line-height: 1.4; }
        .sns-info { display: flex; flex-direction: column; gap: 4px; text-align: left; font-size: 0.8rem; color: #444; }
        .sns-item { display: flex; align-items: center; gap: 6px; }
        .sns-item i { width: 16px; text-align: center; color: #888; }
        .fa-instagram { color: #E1306C !important; }
        .fa-tiktok { color: #000000 !important; }
        .fa-envelope { color: #ff6900 !important; }

        .option-badge { display: inline-block; background: #fff0e6; color: #ff6900; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 4px; font-weight: bold; border: 1px solid #ffccb0; text-align: left; width: 100%; }
        .option-wrapper { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .loading-spinner { text-align: center; padding: 20px; color: #888; }
        
        .btn-cancel { background-color: white; border: 1px solid #e74c3c; color: #e74c3c; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; transition: all 0.2s; }
        .btn-cancel:hover { background-color: #e74c3c; color: white; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo-area"><i class="fa-solid fa-hotel"></i> insta 파트너센터</div>
        <ul class="menu-list">
            <li class="menu-item" onclick="location.href='index.html'"><i class="fa-solid fa-house"></i> 홈</li>
            <li class="menu-item" onclick="location.href='pay.html'"><i class="fa-solid fa-calendar-check"></i> 판매 관리</li>
            <li class="menu-item active" onclick="location.href='reservation.html'"><i class="fa-solid fa-list-check"></i> 예약</li>
            <li class="menu-item" onclick="location.href='settlement.html'"><i class="fa-solid fa-calculator"></i> 정산</li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="content-container">
            <h1 class="page-title">예약내역 통합검색</h1>
            <p class="page-desc">예약한 고객의 예약정보를 입실 일자별 & 상세 조건별로 조회할 수 있습니다.</p>

            <div class="card weekly-status">
                <div class="weekly-header">
                    <div class="weekly-title"><i class="fa-solid fa-bullhorn"></i> 입실 현황 캘린더</div>
                    <div class="date-controls">
                        <button class="btn-today" id="btn-today">오늘</button>
                        <div class="calendar-picker-wrapper">
                            <button class="calendar-icon-btn"><i class="fa-regular fa-calendar-days"></i></button>
                            <input type="date" id="date-picker-input">
                        </div>
                    </div>
                </div>
                <p style="font-size: 0.85rem; color:#666; margin-bottom:15px;">
                    화살표를 눌러 이전/다음 날짜를 계속 확인할 수 있습니다. 날짜를 클릭하면 아래 목록이 갱신됩니다.
                </p>
                <div class="slider-wrapper">
                    <button class="nav-arrow" id="btn-prev"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="date-view-window">
                        <div class="date-container" id="date-track"></div>
                    </div>
                    <button class="nav-arrow" id="btn-next"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="card search-filter">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h4><i class="fa-solid fa-magnifying-glass"></i> 예약내역 상세 검색</h4>
                </div>
                <div class="filter-box" style="border-top:1px solid #eee; padding-top:15px;">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 0.85rem; font-weight: bold; color:#555;">조회 기간 (체크인 기준)</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="date" id="search-start-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <span style="color:#888;">~</span>
                                <input type="date" id="search-end-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 0.85rem; font-weight: bold; color:#555;">예약자 검색</label>
                            <input type="text" id="search-keyword" placeholder="예약자 이름" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 180px;">
                        </div>
                        <div style="display:flex; gap: 5px;">
                            <button id="btn-search-apply" style="padding: 8px 20px; background-color: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">검색하기</button>
                            <button id="btn-search-reset" style="padding: 8px 15px; background-color: #fff; color: #333; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">초기화</button>
                        </div>
                    </div>
                </div>
                 <div class="filter-summary">
                    <div class="status-tabs" id="status-tabs-container">
                        <button class="active" data-status="all">예약 상태 전체</button>
                        <button data-status="confirmed">확정된 예약</button>
                        <button data-status="cancelled">취소된 예약</button>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <div class="table-controls">
                        <span class="summary-text" id="table-summary">조회 결과가 없습니다.</span>
                        <select style="padding:4px;">
                            <option>입실일 내림차순</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">요청사항</th>
                                <th style="width: 10%;">예약자 정보</th>
                                <th style="width: 10%;">객실 타입</th>
                                <th style="width: 15%;">입실/퇴실일시</th>
                                <th style="width: 10%;">예약일시</th>
                                <th style="width: 8%;">예약상태</th>
                                <th style="width: 15%;">판매가 및 입금가</th>
                                <th style="width: 12%;">옵션 (조식 등)</th>
                                <th style="width: 15%;">입실정보 (연락처)</th>
                            </tr>
                        </thead>
                        <tbody id="reservation-list">
                             <tr><td colspan="9" style="padding: 20px;">데이터를 불러오는 중입니다...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
    (function() {
        const supabaseUrl = 'https://eyasihczaqsacenklhns.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5YXNpaGN6YXFzYWNlbmtsaG5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjY5MTIsImV4cCI6MjA3OTk0MjkxMn0.E1J5qEgl79Ato3upXJSL0OyrgsOw6gJbNHo88AWdct0'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        let currentParams = { startDate: '', endDate: '', keyword: '', status: 'all' };

        document.addEventListener('DOMContentLoaded', async function() {
            const dateTrack = document.getElementById('date-track');
            const datePickerInput = document.getElementById('date-picker-input');
            const searchStartDate = document.getElementById('search-start-date');
            const searchEndDate = document.getElementById('search-end-date');
            const searchKeyword = document.getElementById('search-keyword');
            const btnSearchApply = document.getElementById('btn-search-apply');
            const btnSearchReset = document.getElementById('btn-search-reset');
            const reservationList = document.getElementById('reservation-list');
            const tableSummary = document.getElementById('table-summary');
            const statusTabs = document.querySelectorAll('#status-tabs-container button');

            // 1. 객실 이름 매핑
            let roomMap = {}; 
            async function fetchRoomNames() {
                const { data: rooms } = await supabase.from('rooms').select('id, name');
                if(rooms) rooms.forEach(r => roomMap[r.id] = r.name);
            }
            await fetchRoomNames(); 

            // 2. 날짜 초기화
            let centerDate = new Date(); 
            const todayStr = formatDate(new Date());
            searchStartDate.value = todayStr;
            searchEndDate.value = todayStr;
            
            currentParams.startDate = todayStr;
            currentParams.endDate = todayStr;

            renderWeek(centerDate);
            fetchReservations(currentParams);

            // 이벤트 리스너
            document.getElementById('btn-today').addEventListener('click', () => {
                const today = new Date();
                centerDate = new Date(today);
                renderWeek(centerDate);
                setSearchInputs(today, today);
                updateParamsAndFetch(formatDate(today), formatDate(today));
            });

            datePickerInput.addEventListener('change', (e) => {
                if(e.target.value) {
                    const pickedDate = new Date(e.target.value);
                    centerDate = new Date(pickedDate);
                    renderWeek(centerDate);
                    setSearchInputs(pickedDate, pickedDate);
                    updateParamsAndFetch(formatDate(pickedDate), formatDate(pickedDate));
                }
            });

            // [수정 포인트] 7일씩 이동하도록 변경
            document.getElementById('btn-prev').addEventListener('click', () => {
                centerDate.setDate(centerDate.getDate() - 7); // -1에서 -7로 변경
                renderWeek(centerDate);
            });
            document.getElementById('btn-next').addEventListener('click', () => {
                centerDate.setDate(centerDate.getDate() + 7); // +1에서 +7로 변경
                renderWeek(centerDate);
            });

            btnSearchApply.addEventListener('click', () => {
                currentParams.startDate = searchStartDate.value;
                currentParams.endDate = searchEndDate.value;
                currentParams.keyword = searchKeyword.value.trim();
                fetchReservations(currentParams);
            });

            btnSearchReset.addEventListener('click', () => {
                searchKeyword.value = '';
                const today = new Date();
                setSearchInputs(today, today);
                centerDate = new Date(today);
                renderWeek(centerDate);
                updateParamsAndFetch(formatDate(today), formatDate(today), '');
            });

            statusTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    statusTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentParams.status = this.getAttribute('data-status');
                    fetchReservations(currentParams);
                });
            });

            function updateParamsAndFetch(start, end, keyword = currentParams.keyword) {
                currentParams.startDate = start;
                currentParams.endDate = end;
                currentParams.keyword = keyword;
                fetchReservations(currentParams);
            }

            // 상단 캘린더 렌더링
            async function renderWeek(pivotDate) {
                dateTrack.innerHTML = ''; 
                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                const datesToShow = [];
                
                for (let i = -3; i <= 3; i++) {
                    const tempDate = new Date(pivotDate);
                    tempDate.setDate(tempDate.getDate() + i);
                    datesToShow.push(tempDate);
                }

                const startDateStr = formatDate(datesToShow[0]);
                const endDateStr = formatDate(datesToShow[datesToShow.length - 1]);

                // 예약 건수 가져오기
                const { data: bookings } = await supabase
                    .from('bookings')
                    .select('check_in') 
                    .gte('check_in', startDateStr + ' 00:00:00')
                    .lte('check_in', endDateStr + ' 23:59:59')
                    .neq('status', 'cancelled'); 

                const counts = {};
                if (bookings) {
                    bookings.forEach(booking => {
                        const dateKey = booking.check_in.substring(0, 10);
                        counts[dateKey] = (counts[dateKey] || 0) + 1;
                    });
                }

                datesToShow.forEach(dateObj => {
                    const yyyy = dateObj.getFullYear();
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    const dayNum = dateObj.getDay();
                    const dayName = dayNames[dayNum];
                    const fullDateStr = `${yyyy}-${mm}-${dd}`;

                    const box = document.createElement('div');
                    box.className = 'date-box';
                    if(dayNum === 0) box.classList.add('sun');
                    if(dayNum === 6) box.classList.add('sat');
                    if(fullDateStr === todayStr) box.classList.add('is-today');
                    
                    if (fullDateStr === searchStartDate.value) box.classList.add('active');

                    box.addEventListener('click', () => {
                        centerDate = new Date(dateObj); 
                        renderWeek(centerDate); 
                        setSearchInputs(dateObj, dateObj); 
                        updateParamsAndFetch(fullDateStr, fullDateStr); 
                    });

                    let stayCount = counts[fullDateStr] || 0;

                    // [대실 라인 삭제됨]
                    box.innerHTML = `
                        <div class="today-badge">오늘</div>
                        <div class="box-header">
                            <div class="year-month">${yyyy}.${mm}</div>
                            <div class="date-row">
                                ${dd} <span class="day-str">${dayName}</span>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="count-row">
                                <span class="label stay">숙박</span>
                                <span class="val-stay">${stayCount}</span>
                            </div>
                        </div>
                    `;
                    dateTrack.appendChild(box);
                });
            }

            // 하단 예약 리스트 조회
            async function fetchReservations(params) {
                reservationList.innerHTML = '<tr><td colspan="9" class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> 데이터를 불러오는 중...</td></tr>';

                let query = supabase
                    .from('bookings')
                    .select('*')
                    .gte('check_in', params.startDate + ' 00:00:00')
                    .lte('check_in', params.endDate + ' 23:59:59')
                    .order('created_at', { ascending: false });

                if (params.keyword) query = query.ilike('guest_name', `%${params.keyword}%`);
                if (params.status && params.status !== 'all') query = query.eq('status', params.status);

                const { data: bookings, error } = await query;
                if (error) {
                    reservationList.innerHTML = '<tr><td colspan="9">데이터 조회 실패</td></tr>';
                    return;
                }
                renderTableRows(bookings, params);
            }

            function renderTableRows(bookings, params) {
                if (!bookings || bookings.length === 0) {
                    reservationList.innerHTML = '<tr><td colspan="9" style="padding:30px; color:#888;">조건에 맞는 예약 내역이 없습니다.</td></tr>';
                    tableSummary.innerText = `[${params.startDate} ~ ${params.endDate}] 조회 결과: 0건`;
                    return;
                }

                let html = '';
                let completedCount = 0, cancelledCount = 0, totalRevenue = 0;

                bookings.forEach(booking => {
                    const isCancelled = (booking.status === 'cancelled');
                    const totalPrice = Number(booking.total_price || 0);
                    const settlementPrice = Math.floor(totalPrice * 0.97);

                    if (!isCancelled) {
                        completedCount++;
                        totalRevenue += totalPrice;
                    } else {
                        cancelledCount++;
                    }

                    let statusBadge = isCancelled ? '<span style="color:#e74c3c; font-weight:bold;">취소</span>' : '<span style="color:#2ecc71; font-weight:bold;">예약확정</span>';
                    let actionBtn = isCancelled 
                        ? `<span style="font-size:0.75rem; color:#aaa;">${booking.cancelled_at ? formatDate(new Date(booking.cancelled_at))+' 취소됨' : '-'}</span>`
                        : `<button class="btn-cancel" onclick="cancelBooking(${booking.id}, '${booking.guest_name}')">예약 취소</button>`;

                    const roomName = roomMap[booking.room_id] || `객실 ${booking.room_id}`;
                    const checkInDate = new Date(booking.check_in);
                    const checkOutDate = new Date(booking.check_out);
                    const createdDate = new Date(booking.created_at);
                    const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
                    const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    let optionsHtml = '<span style="color:#ccc; font-size:0.8rem;">선택안함</span>';
                    if (booking.selected_options && Array.isArray(booking.selected_options) && booking.selected_options.length > 0) {
                        optionsHtml = `<div class="option-wrapper">` + booking.selected_options.map(opt => `<span class="option-badge">${opt}</span>`).join('') + `</div>`;
                    }

                    html += `
                        <tr>
                            <td><div class="request-text">${booking.guest_request || '-'}</div></td>
                            <td><strong>${booking.guest_name}</strong></td>
                            <td><span class="room-type">${roomName}</span><span class="stay-info">숙박 / ${nights}박</span></td>
                            <td>${formatDateDot(checkInDate)} 15:00<br>${formatDateDot(checkOutDate)} 12:00</td>
                            <td>${formatDateDot(createdDate)}<br><span style="font-size:0.8rem; color:#888;">${formatTime(createdDate)}</span></td>
                            <td>${statusBadge}<div>${actionBtn}</div></td>
                            <td style="text-align: right; padding-right: 20px;">
                                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                                    <span style="font-size: 0.9rem; color: #555;">결제금액 <strong>${totalPrice.toLocaleString()}원</strong></span>
                                    <span style="font-size: 0.95rem; color: #333; font-weight: bold;">입금가 <span style="color:#ff6900;">${settlementPrice.toLocaleString()}원</span></span>
                                    <span style="font-size: 0.75rem; color: #aaa;">(수수료 3% 제외)</span>
                                </div>
                            </td>
                            <td style="vertical-align: top; padding-top:20px;">${optionsHtml}</td>
                            <td>
                                <div class="sns-info">
                                    <div class="sns-item"><i class="fa-solid fa-phone"></i> ${booking.phone || '-'}</div>
                                    <div class="sns-item"><i class="fa-solid fa-envelope"></i> ${booking.guest_email || '-'}</div>
                                    <div class="sns-item"><i class="fa-brands fa-instagram"></i> ${booking.social_insta || '-'}</div>
                                    <div class="sns-item"><i class="fa-brands fa-tiktok"></i> ${booking.social_tiktok || '-'}</div>
                                </div>
                            </td>
                        </tr>`;
                });

                reservationList.innerHTML = html;
                let statusLabel = params.status === 'confirmed' ? "확정만" : (params.status === 'cancelled' ? "취소만" : "전체");
                tableSummary.innerText = `[${params.startDate}~${params.endDate}] (${statusLabel}) 총 ${bookings.length}개 (확정 ${completedCount} / 취소 ${cancelledCount}) | 매출액 ${totalRevenue.toLocaleString()}원`;
            }

            function formatDate(date) { 
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }
            function formatDateDot(date) { 
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                const dayName = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];
                return `${yyyy}.${mm}.${dd}(${dayName})`;
            }
            function formatTime(date) {
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                return `${hh}:${mm}`;
            }
            function setSearchInputs(start, end) {
                searchStartDate.value = formatDate(start);
                searchEndDate.value = formatDate(end);
            }

            window.cancelBooking = async function(bookingId, guestName) {
                if(confirm(`[${guestName}] 고객님의 예약을 정말 취소하시겠습니까?`)) {
                    const { error } = await supabase.from('bookings').update({ status: 'cancelled', cancelled_at: new Date() }).eq('id', bookingId);
                    if(error) alert("취소 실패: " + error.message);
                    else {
                        alert("예약이 취소되었습니다.");
                        fetchReservations(currentParams);
                        renderWeek(centerDate);
                    }
                }
            };
        });
    })(); // End IIFE
    </script>
</body>
</html>
