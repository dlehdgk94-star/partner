<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta 파트너센터 - 예약 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 기본 스타일 초기화 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }

        /* 사이드바 */
        .sidebar { width: 240px; background-color: #ff6900; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .menu-list { list-style: none; margin-top: 10px; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .menu-item:hover { background-color: #e65c00; }
        .menu-item.active { background-color: #cc5200; font-weight: bold; }

        /* 메인 콘텐츠 */
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .page-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .page-desc { font-size: 0.9rem; color: #666; margin-bottom: 30px; }

        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* 캘린더 관련 스타일 */
        .weekly-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .weekly-title { font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .date-controls { display: flex; align-items: center; gap: 10px; }
        .btn-today { background-color: #fff; border: 1px solid #ccc; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-today:hover { background-color: #f0f0f0; border-color: #bbb; }
        .calendar-picker-wrapper { position: relative; display: flex; align-items: center; }
        .calendar-icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #555; padding: 5px; transition: color 0.2s; }
        #date-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .slider-wrapper { display: flex; align-items: center; justify-content: space-between; gap: 15px; background-color: #fff; }
        .nav-arrow { width: 40px; height: 80px; border: 1px solid #eee; background-color: #fff; border-radius: 4px; cursor: pointer; color: #888; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-top: 10px; }
        .nav-arrow:hover { background-color: #f9f9f9; color: #ff6900; border-color: #ff6900; }
        .date-view-window { flex-grow: 1; overflow: hidden; padding-top: 25px; padding-bottom: 5px; }
        .date-container { display: flex; gap: 10px; width: 100%; }
        .date-box { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 15px 0; text-align: center; cursor: pointer; position: relative; background: white; transition: border-color 0.2s, background-color 0.2s; min-width: 0; }
        .date-box:hover { border-color: #ff6900; }
        .date-box.active { border: 2px solid #ff6900; background-color: #fff0e6; }
        .date-text { font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; color: #333; white-space: nowrap; }
        .count { font-size: 0.9rem; color: #ff6900; font-weight: bold; white-space: nowrap; }
        .today-badge { position: absolute; top: -24px; left: 50%; transform: translateX(-50%); background-color: #ff6900; color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 12px; display: none; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; }
        .date-box.is-today .today-badge { display: block; }

        /* ▼▼▼ [새로 추가] 상세 검색 필터 스타일 ▼▼▼ */
        .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer; }
        .search-toggle-btn { border: none; background: none; cursor: pointer; font-size: 0.9rem; color: #555; }
        
        .filter-content { display: block; /* 기본 열림 */ border-top: 1px solid #eee; padding-top: 20px; }
        .filter-row { display: flex; align-items: center; margin-bottom: 15px; font-size: 0.9rem; }
        .filter-label { width: 100px; font-weight: bold; color: #333; flex-shrink: 0; }
        .filter-input-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; flex-grow: 1; }
        
        .form-select, .form-input { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        .form-input-date { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; width: 130px; }
        
        .btn-group { display: flex; }
        .btn-group button { background: white; border: 1px solid #ccc; padding: 6px 12px; font-size: 0.85rem; cursor: pointer; border-right: none; }
        .btn-group button:first-child { border-radius: 4px 0 0 4px; }
        .btn-group button:last-child { border-radius: 0 4px 4px 0; border-right: 1px solid #ccc; }
        .btn-group button:hover { background-color: #f5f5f5; }
        .btn-group button.selected { background-color: #333; color: white; border-color: #333; }

        .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 15px; }
        .radio-group input[type="radio"] { accent-color: #00c7ae; } /* 민트색 포인트 */

        .search-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f0f0f0; }
        .btn-reset { background: white; border: 1px solid #ccc; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-search { background: #1f3a60; color: white; border: 1px solid #1f3a60; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-search:hover { background: #152b4a; }
        /* ▲▲▲ 상세 검색 스타일 끝 ▲▲▲ */

        .filter-summary { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 15px; border-radius: 4px; }
        .status-tabs button { padding: 8px 16px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.9rem; margin-right: -1px; }
        .status-tabs button.active { background-color: #ff6900; color: white; border-color: #ff6900; }
        .status-tabs button:first-child { border-radius: 4px 0 0 4px; }
        .status-tabs button:last-child { border-radius: 0 4px 4px 0; }

        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .summary-text { font-size: 0.9rem; font-weight: bold; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; border-top: 2px solid #ddd; }
        .data-table th { background-color: #f5f5f5; padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; }
        .data-table td { padding: 15px 12px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }

        .room-type { font-weight: bold; display: block; }
        .stay-info { font-size: 0.8rem; color: #ff6900; }
        .price-original { text-decoration: line-through; color: #999; font-size: 0.8rem; display: block;}
        .price-final { font-weight: bold; color: #333; }
        
        .request-text { font-size: 0.85rem; color: #555; text-align: left; max-width: 150px; line-height: 1.4; }
        .sns-info { display: flex; flex-direction: column; gap: 4px; text-align: left; font-size: 0.8rem; color: #444; }
        .sns-item { display: flex; align-items: center; gap: 6px; }
        .sns-item i { width: 16px; text-align: center; color: #888; }
        .fa-instagram { color: #E1306C !important; }
        .fa-tiktok { color: #000000 !important; }
        .fa-envelope { color: #ff6900 !important; }

        /* 옵션 표시 스타일 */
        .option-badge { display: inline-block; background: #fff0e6; color: #ff6900; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 4px; font-weight: bold; border: 1px solid #ffccb0; text-align: left; width: 100%; }
        .option-wrapper { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .loading-spinner { text-align: center; padding: 20px; color: #888; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-hotel"></i> insta 파트너센터
        </div>
        <ul class="menu-list">
            <li class="menu-item"><i class="fa-solid fa-house"></i> 홈</li>
            <li class="menu-item"><i class="fa-solid fa-calendar-check"></i> 판매 관리</li>
            <li class="menu-item active"><i class="fa-solid fa-list-check"></i> 예약</li>
            <li class="menu-item"><i class="fa-solid fa-calculator"></i> 정산</li>
        </ul>
    </nav>

    <main class="main-content">
        <h1 class="page-title">예약내역 통합검색</h1>
        <p class="page-desc">예약한 고객의 예약정보를 입실 일자별 & 상세 조건별로 조회할 수 있습니다.</p>

        <div class="card weekly-status">
            <div class="weekly-header">
                <div class="weekly-title"><i class="fa-solid fa-bullhorn"></i> 입실 현황 캘린더</div>
                <div class="date-controls">
                    <button class="btn-today" id="btn-today">오늘</button>
                    <div class="calendar-picker-wrapper">
                        <button class="calendar-icon-btn"><i class="fa-regular fa-calendar-days"></i></button>
                        <input type="date" id="date-picker-input">
                    </div>
                </div>
            </div>
            <p style="font-size: 0.85rem; color:#666; margin-bottom:15px;">화살표를 눌러 이전/다음 날짜를 계속 확인할 수 있습니다.</p>
            <div class="slider-wrapper">
                <button class="nav-arrow" id="btn-prev"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="date-view-window">
                    <div class="date-container" id="date-track"></div>
                </div>
                <button class="nav-arrow" id="btn-next"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="card search-filter">
            <div class="search-header" onclick="toggleFilter()">
                <h4><i class="fa-solid fa-magnifying-glass"></i> 예약내역 상세 검색</h4>
                <button class="search-toggle-btn" id="toggle-btn-icon">접기 <i class="fa-solid fa-chevron-up"></i></button>
            </div>
            
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">1주일 간의 입실 현황을 확인하고 싶을 경우 '1주일 간의 입실 현황'을 활용해주세요.<br>조건을 설정한 후 '검색' 버튼을 눌러주세요.</p>

            <div class="filter-content" id="filter-content">
                <div class="filter-row">
                    <div class="filter-label">기간</div>
                    <div class="filter-input-group">
                        <select class="form-select">
                            <option>입실일</option>
                        </select>
                        <div class="btn-group">
                            <button onclick="setFilterDate('yesterday')">어제</button>
                            <button onclick="setFilterDate('today')" class="selected">오늘</button>
                            <button onclick="setFilterDate('tomorrow')">내일</button>
                            <button onclick="setFilterDate('next7')">다음 7일</button>
                        </div>
                        <span style="font-size:0.8rem; color:#666;">시작일</span>
                        <input type="date" id="filter-start-date" class="form-input-date">
                        <span style="font-size:0.8rem; color:#666;">~ 종료일</span>
                        <input type="date" id="filter-end-date" class="form-input-date">
                        <label style="font-size:0.9rem; display:flex; align-items:center; gap:5px; cursor:pointer;">
                            <input type="checkbox" id="same-day-check"> 당일 예약만 보기
                        </label>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label">예약상태</div>
                    <div class="filter-input-group radio-group">
                        <label><input type="radio" name="status" value="all" checked> <span style="color:#00c7ae; font-weight:bold;">●</span> 전체</label>
                        <label><input type="radio" name="status" value="confirmed"> 예약완료</label>
                        <label><input type="radio" name="status" value="cancelled"> 예약취소(고객)</label>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label">객실 타입</div>
                    <div class="filter-input-group">
                        <select class="form-select" id="room-select" style="width: 200px;">
                            <option value="all">전체</option>
                            </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label">검색어</div>
                    <div class="filter-input-group">
                        <select class="form-select">
                            <option>예약자명</option>
                        </select>
                        <input type="text" id="search-keyword" class="form-input" placeholder="예약자명을 입력해주세요." style="width: 300px;">
                    </div>
                </div>

                <div class="search-footer">
                    <button class="btn-reset" onclick="resetFilters()">초기화</button>
                    <button class="btn-search" id="btn-search-action">검색</button>
                </div>
            </div>

             <div class="filter-summary">
                <div class="status-tabs">
                    <button class="active">예약 상태 전체</button>
                    <button>확정된 예약</button>
                    <button>취소된 예약</button>
                </div>
            </div>

            <div style="margin-top:20px;">
                <div class="table-controls">
                    <span class="summary-text" id="table-summary">조회 결과가 없습니다.</span>
                    <select style="padding:4px;">
                        <option>입실일 내림차순</option>
                    </select>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">요청사항</th>
                            <th style="width: 10%;">예약자 정보</th>
                            <th style="width: 10%;">객실 타입</th>
                            <th style="width: 15%;">입실/퇴실일시</th>
                            <th style="width: 10%;">예약일시</th>
                            <th style="width: 8%;">예약상태</th>
                            <th style="width: 15%;">금액 및 할인정보</th>
                            <th style="width: 12%;">선택 옵션 (조식 등)</th>
                            <th style="width: 15%;">입실 정보 (연락처)</th>
                        </tr>
                    </thead>
                    <tbody id="reservation-list">
                         <tr><td colspan="9" style="padding: 20px;">검색 조건을 설정하고 검색 버튼을 눌러주세요.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const YOUR_SUPABASE_URL = 'https://eyasihczaqsacenklhns.supabase.co'; 
        const YOUR_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5YXNpaGN6YXFzYWNlbmtsaG5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjY5MTIsImV4cCI6MjA3OTk0MjkxMn0.E1J5qEgl79Ato3upXJSL0OyrgsOw6gJbNHo88AWdct0'; 
        const supabase = window.supabase.createClient(YOUR_SUPABASE_URL, YOUR_SUPABASE_KEY);

        // 전역 변수 설정 (필터 상태 관리용)
        let roomMap = {}; 

        document.addEventListener('DOMContentLoaded', async function() {
            // DOM 요소
            const dateTrack = document.getElementById('date-track');
            const datePickerInput = document.getElementById('date-picker-input');
            const btnToday = document.getElementById('btn-today');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const reservationList = document.getElementById('reservation-list');
            const tableSummary = document.getElementById('table-summary');
            
            // 필터 DOM
            const filterStartDate = document.getElementById('filter-start-date');
            const filterEndDate = document.getElementById('filter-end-date');
            const roomSelect = document.getElementById('room-select');
            const searchKeyword = document.getElementById('search-keyword');
            const btnSearchAction = document.getElementById('btn-search-action');

            // --- 1. 객실 목록 가져와서 Select 박스 채우기 ---
            async function fetchRoomNames() {
                const { data: rooms, error } = await supabase.from('rooms').select('id, name');
                if(rooms) {
                    rooms.forEach(r => {
                        roomMap[r.id] = r.name; 
                        // 필터 Select에 옵션 추가
                        const option = document.createElement('option');
                        option.value = r.id;
                        option.innerText = r.name;
                        roomSelect.appendChild(option);
                    });
                }
            }
            await fetchRoomNames(); 

            // --- 2. 기본 날짜 설정 (오늘) ---
            let centerDate = new Date(); 
            let selectedDateStr = formatDate(centerDate); 
            
            // 필터 초기값: 오늘
            setFilterDate('today');

            // --- 3. 캘린더 초기 실행 ---
            renderWeek(centerDate);
            // 초기 데이터 로드는 캘린더 기준(오늘)으로 한번 실행
            renderReservationTable({ type: 'date', value: selectedDateStr });

            // --- 이벤트 리스너들 ---
            btnToday.addEventListener('click', function() {
                const today = new Date();
                centerDate = new Date(today);
                renderWeek(centerDate);
            });

            datePickerInput.addEventListener('change', function(e) {
                if(e.target.value) {
                    centerDate = new Date(e.target.value);
                    renderWeek(centerDate);
                }
            });

            btnPrev.addEventListener('click', () => { centerDate.setDate(centerDate.getDate() - 1); renderWeek(centerDate); });
            btnNext.addEventListener('click', () => { centerDate.setDate(centerDate.getDate() + 1); renderWeek(centerDate); });

            // ★★★ 검색 버튼 클릭 이벤트 ★★★
            btnSearchAction.addEventListener('click', function() {
                const startDate = filterStartDate.value;
                const endDate = filterEndDate.value;
                const statusRadio = document.querySelector('input[name="status"]:checked').value;
                const roomId = roomSelect.value;
                const keyword = searchKeyword.value;

                // 필터 조건 객체 생성
                const filters = {
                    type: 'filter',
                    startDate: startDate,
                    endDate: endDate,
                    status: statusRadio, // 'all', 'confirmed', 'cancelled'
                    roomId: roomId,      // 'all' or numeric ID
                    keyword: keyword
                };

                renderReservationTable(filters);
            });

            // --- 캘린더 그리기 함수 ---
            async function renderWeek(pivotDate) {
                dateTrack.innerHTML = ''; 
                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                const todayStr = formatDate(new Date());

                const datesToShow = [];
                for (let i = -3; i <= 3; i++) {
                    const tempDate = new Date(pivotDate);
                    tempDate.setDate(tempDate.getDate() + i);
                    datesToShow.push(tempDate);
                }

                const startDateStr = formatDate(datesToShow[0]);
                const endDateStr = formatDate(datesToShow[datesToShow.length - 1]);

                const { data: bookings } = await supabase
                    .from('bookings')
                    .select('check_in') 
                    .gte('check_in', startDateStr + ' 00:00:00')
                    .lte('check_in', endDateStr + ' 23:59:59');

                const counts = {};
                if (bookings) {
                    bookings.forEach(booking => {
                        const dateKey = booking.check_in.substring(0, 10);
                        counts[dateKey] = (counts[dateKey] || 0) + 1;
                    });
                }

                datesToShow.forEach(dateObj => {
                    const yyyy = dateObj.getFullYear();
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    const dayName = dayNames[dateObj.getDay()];
                    const dateString = `${yyyy}.${mm}.${dd}`; 
                    const fullDateStr = `${yyyy}-${mm}-${dd}`;

                    const box = document.createElement('div');
                    box.className = 'date-box';
                    if (fullDateStr === todayStr) box.classList.add('is-today');
                    
                    // 캘린더 날짜 클릭 시 해당 날짜로 검색 실행
                    box.addEventListener('click', function() {
                        // 모든 date-box active 제거 후 현재 것만 추가
                        document.querySelectorAll('.date-box').forEach(b => b.classList.remove('active'));
                        box.classList.add('active');
                        
                        renderReservationTable({ type: 'date', value: fullDateStr });
                    });

                    let countNum = counts[fullDateStr] || 0;
                    box.innerHTML = `
                        <div class="today-badge">오늘</div>
                        <div class="date-text">${dateString} (${dayName})</div>
                        <div class="count">숙박 ${countNum}</div>
                    `;
                    dateTrack.appendChild(box);
                });
            }

            // --- ★★★ 핵심: 데이터 조회 및 테이블 렌더링 함수 ★★★ ---
            async function renderReservationTable(condition) {
                reservationList.innerHTML = '<tr><td colspan="9" class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> 검색 중...</td></tr>';

                let query = supabase.from('bookings').select('*').order('created_at', { ascending: false });

                // 1. 조건에 따른 쿼리 빌드
                if (condition.type === 'date') {
                    // 캘린더 클릭 시 (단일 날짜)
                    query = query.gte('check_in', condition.value + ' 00:00:00')
                                 .lte('check_in', condition.value + ' 23:59:59');
                } else if (condition.type === 'filter') {
                    // 상세 검색 시
                    if (condition.startDate) query = query.gte('check_in', condition.startDate + ' 00:00:00');
                    if (condition.endDate) query = query.lte('check_in', condition.endDate + ' 23:59:59');
                    
                    if (condition.status !== 'all') {
                        // DB에는 confirmed, cancelled로 저장되어 있다고 가정
                        // 한글 매핑이 필요하면 여기서 변환
                        let dbStatus = condition.status; 
                        // 예: 화면은 'cancelled' -> DB도 'cancelled' (value값 기준)
                        query = query.eq('status', dbStatus);
                    }

                    if (condition.roomId !== 'all') {
                        query = query.eq('room_id', condition.roomId);
                    }

                    if (condition.keyword) {
                        query = query.ilike('guest_name', `%${condition.keyword}%`);
                    }
                }

                const { data: bookings, error } = await query;

                if (error) {
                    console.error("조회 에러:", error);
                    reservationList.innerHTML = '<tr><td colspan="9">데이터 조회 중 오류가 발생했습니다.</td></tr>';
                    return;
                }

                if (!bookings || bookings.length === 0) {
                    reservationList.innerHTML = '<tr><td colspan="9" style="padding:30px; color:#888;">조회된 예약 내역이 없습니다.</td></tr>';
                    tableSummary.innerText = `총 0개 (완료 0 / 취소 0) | 매출액 0원 | 입금 예정가 0원`;
                    return;
                }

                // 2. 테이블 HTML 생성
                let html = '';
                let totalCount = bookings.length;
                let completedCount = 0; 
                let cancelledCount = 0; 
                let totalRevenue = 0; 

                bookings.forEach(booking => {
                    // 통계 계산
                    if (booking.status === 'confirmed' || booking.status === '예약확정') {
                        completedCount++;
                        totalRevenue += (booking.total_price || 0);
                    } else if (booking.status === 'cancelled' || booking.status === '취소') {
                        cancelledCount++;
                    }

                    const price = booking.total_price || 0;
                    let statusBadge = booking.status;
                    if(statusBadge === 'confirmed') statusBadge = '<span style="color:#2ecc71; font-weight:bold;">예약확정</span>';
                    else if(statusBadge === 'cancelled') statusBadge = '<span style="color:#e74c3c; font-weight:bold;">취소</span>';
                    else statusBadge = '<span style="color:#95a5a6;">' + statusBadge + '</span>';

                    const checkInDate = new Date(booking.check_in);
                    const checkOutDate = new Date(booking.check_out);
                    const createdDate = new Date(booking.created_at);
                    const roomName = roomMap[booking.room_id] || `객실 ${booking.room_id}`; 

                    let optionsHtml = '<span style="color:#ccc; font-size:0.8rem;">선택안함</span>';
                    if (booking.selected_options && Array.isArray(booking.selected_options) && booking.selected_options.length > 0) {
                        optionsHtml = `<div class="option-wrapper">`;
                        booking.selected_options.forEach(opt => {
                            optionsHtml += `<span class="option-badge">${opt}</span>`;
                        });
                        optionsHtml += `</div>`;
                    }

                    html += `
                        <tr>
                            <td><div class="request-text">${booking.guest_request || '-'}</div></td>
                            <td><strong>${booking.guest_name}</strong></td>
                            <td>
                                <span class="room-type">${roomName}</span>
                                <span class="stay-info">숙박 / 1박</span>
                            </td>
                            <td>
                                ${formatDateDot(checkInDate)} 15:00<br>
                                ${formatDateDot(checkOutDate)} 11:00
                            </td>
                            <td>
                                ${formatDateDot(createdDate)}<br>
                                <span style="font-size:0.8rem; color:#888;">${formatTime(createdDate)}</span>
                            </td>
                            <td>${statusBadge}</td>
                            <td>
                                <span class="price-original">객실가 ${Number(booking.room_price).toLocaleString()}원</span>
                                <span class="price-final">총 결제금액 ${Number(booking.total_price).toLocaleString()}원</span>
                            </td>
                            <td style="vertical-align: top; padding-top:20px;">${optionsHtml}</td>
                            <td>
                                <div class="sns-info">
                                    <div class="sns-item"><i class="fa-solid fa-phone"></i> ${booking.phone || '-'}</div>
                                    <div class="sns-item"><i class="fa-solid fa-envelope"></i> ${booking.guest_email || '-'}</div>
                                    <div class="sns-item"><i class="fa-brands fa-instagram"></i> ${booking.social_insta || '-'}</div>
                                    <div class="sns-item"><i class="fa-brands fa-tiktok"></i> ${booking.social_tiktok || '-'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                reservationList.innerHTML = html;
                tableSummary.innerText = `총 ${totalCount}개 (완료 ${completedCount} / 취소 ${cancelledCount}) | 매출액 ${totalRevenue.toLocaleString()}원 | 입금 예정가 0원`;
            }
        });

        // --- 전역 유틸리티 함수 ---
        function formatDate(date) { 
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatDateDot(date) { 
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const dayName = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];
            return `${yyyy}.${mm}.${dd}(${dayName})`;
        }

        function formatTime(date) {
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        function updatePeriodText(dateStr, dayName) {
            // 이 기능은 상세검색 필터로 대체되었으나 기존 캘린더 로직 유지를 위해 남겨둠
        }

        // --- 필터 UI 제어 함수 ---
        function toggleFilter() {
            const content = document.getElementById('filter-content');
            const btnIcon = document.getElementById('toggle-btn-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btnIcon.innerHTML = '접기 <i class="fa-solid fa-chevron-up"></i>';
            } else {
                content.style.display = 'none';
                btnIcon.innerHTML = '펼치기 <i class="fa-solid fa-chevron-down"></i>';
            }
        }

        function setFilterDate(type) {
            const today = new Date();
            let start = new Date();
            let end = new Date();

            if (type === 'yesterday') {
                start.setDate(today.getDate() - 1);
                end.setDate(today.getDate() - 1);
            } else if (type === 'today') {
                // start, end is today
            } else if (type === 'tomorrow') {
                start.setDate(today.getDate() + 1);
                end.setDate(today.getDate() + 1);
            } else if (type === 'next7') {
                end.setDate(today.getDate() + 7);
            }

            document.getElementById('filter-start-date').value = formatDate(start);
            document.getElementById('filter-end-date').value = formatDate(end);

            // 버튼 스타일 활성화
            const btns = document.querySelectorAll('.btn-group button');
            btns.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function resetFilters() {
            setFilterDate('today');
            document.querySelector('input[name="status"][value="all"]').checked = true;
            document.getElementById('room-select').value = 'all';
            document.getElementById('search-keyword').value = '';
            document.getElementById('same-day-check').checked = false;
        }
    </script>
</body>
</html>
