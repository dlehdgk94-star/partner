<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta 파트너센터 - 예약 관리</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 기본 스타일 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        
        /* 사이드바 */
        .sidebar { width: 240px; background-color: #ff6900; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .menu-list { list-style: none; margin-top: 10px; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .menu-item:hover { background-color: #e65c00; }
        .menu-item.active { background-color: #cc5200; font-weight: bold; }
        
        /* 메인 콘텐츠 */
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; overflow-x: hidden; }
        .page-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .page-desc { font-size: 0.9rem; color: #666; margin-bottom: 30px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* [수정됨] 무한 스크롤 날짜 컨테이너 스타일 */
        .scroll-container-wrapper {
            position: relative;
            width: 100%;
            overflow: hidden; /* 넘치는 것 숨김 (내부에서 스크롤) */
        }
        
        .date-scroll-container { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; /* 가로 스크롤 활성화 */
            padding-bottom: 10px; /* 스크롤바 공간 확보 */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* 모바일 부드러운 스크롤 */
        }

        /* 스크롤바 스타일링 (선택사항 - 깔끔하게) */
        .date-scroll-container::-webkit-scrollbar { height: 8px; }
        .date-scroll-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .date-scroll-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .date-scroll-container::-webkit-scrollbar-thumb:hover { background: #bbb; }

        .date-box { 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 15px 0; 
            flex: 0 0 120px; /* 고정 너비 120px (줄어들지 않음) */
            text-align: center; 
            cursor: pointer; 
            position: relative; 
            background: white;
            transition: all 0.2s;
        }
        .date-box:hover { border-color: #ff6900; }
        .date-box.active { border: 2px solid #ff6900; background-color: #fff0e6; }
        .date-box .date-text { font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; color: #333; white-space: nowrap; }
        .date-box .count { font-size: 0.9rem; color: #ff6900; font-weight: bold; }
        .today-badge { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background-color: #ff6900; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }

        /* --- 나머지 스타일 (테이블 등) --- */
        .search-filter { border: 1px solid #eee; }
        .filter-summary { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 15px; border-radius: 4px; }
        .status-tabs button { padding: 8px 16px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.9rem; margin-right: -1px; }
        .status-tabs button.active { background-color: #ff6900; color: white; border-color: #ff6900; }
        .status-tabs button:first-child { border-radius: 4px 0 0 4px; }
        .status-tabs button:last-child { border-radius: 0 4px 4px 0; }
        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .summary-text { font-size: 0.9rem; font-weight: bold; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; border-top: 2px solid #ddd; }
        .data-table th { background-color: #f5f5f5; padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; }
        .data-table td { padding: 15px 12px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
        .room-type { font-weight: bold; display: block; }
        .stay-info { font-size: 0.8rem; color: #ff6900; }
        .price-final { font-weight: bold; color: #333; }
        .request-text { font-size: 0.85rem; color: #555; text-align: left; max-width: 150px; line-height: 1.4; }
        .sns-info { display: flex; flex-direction: column; gap: 4px; text-align: left; font-size: 0.8rem; color: #444; }
        .sns-item { display: flex; align-items: center; gap: 6px; }
        .sns-item i { width: 16px; text-align: center; color: #888; }
        .fa-instagram { color: #E1306C !important; }
        .fa-tiktok { color: #000000 !important; }
        .fa-envelope { color: #ff6900 !important; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-hotel"></i> insta 파트너센터
        </div>
        <ul class="menu-list">
            <li class="menu-item"><i class="fa-solid fa-house"></i> 홈</li>
            <li class="menu-item"><i class="fa-solid fa-calendar-check"></i> 판매 관리</li>
            <li class="menu-item active"><i class="fa-solid fa-list-check"></i> 예약</li>
            <li class="menu-item"><i class="fa-solid fa-calculator"></i> 정산</li>
        </ul>
    </nav>

    <main class="main-content">
        <h1 class="page-title">예약내역 통합검색</h1>
        <p class="page-desc">예약한 고객의 예약정보를 입실 일자별 & 상세 조건별로 조회할 수 있습니다.</p>

        <div class="card weekly-status">
            <div style="margin-bottom: 15px;">
                <h3><i class="fa-solid fa-calendar-days"></i> 날짜별 입실 현황</h3>
                <p style="font-size: 0.85rem; color:#666; margin-top:5px;">
                    좌우로 스크롤하여 날짜를 선택하세요. (오늘부터 약 6개월간 조회 가능)
                </p>
            </div>
            
            <div class="scroll-container-wrapper">
                <div class="date-scroll-container" id="date-scroll-container">
                    <div style="padding:20px; width:100%; text-align:center; color:#999;">날짜 로딩 중...</div>
                </div>
            </div>
        </div>

        <div class="card search-filter">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4><i class="fa-solid fa-magnifying-glass"></i> 예약내역 상세 검색</h4>
                <button style="border:none; background:none; cursor:pointer;">펼치기 <i class="fa-solid fa-chevron-down"></i></button>
            </div>
            
            <div class="filter-box" style="border-top:1px solid #eee; padding-top:15px;">
                <p style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;">선택된 날짜 (입실일 기준)</p>
                <p style="font-size:0.9rem; color:#ff6900; font-weight:bold;" id="selected-date-display">-</p>
            </div>

            <div class="filter-summary">
                <div class="status-tabs">
                    <button class="active">입실 상태 전체</button>
                    <button>입실 전만 보기</button>
                    <button>입실 완료만 보기</button>
                </div>
            </div>

            <div style="margin-top:20px;">
                <div class="table-controls">
                    <span class="summary-text" id="table-summary-text">조회 중...</span>
                    <select style="padding:4px;">
                        <option>입실일 내림차순</option>
                    </select>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>요청사항</th>
                            <th>예약자 정보</th>
                            <th>객실 타입</th>
                            <th>입실/퇴실일시</th>
                            <th>예약일시</th>
                            <th>예약상태</th>
                            <th>금액</th>
                            <th>입실 상태</th>
                            <th>입실 정보 (연락처)</th>
                        </tr>
                    </thead>
                    <tbody id="reservation-list">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ★ Supabase 설정 (본인 정보 확인)
        const supabaseUrl = 'https://eyasihczaqsacenklhns.supabase.co';
        const supabaseKey = 'sb_publishable_KgiOOQUrWJzQTDCZnbhGcw_otKoMO27';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 상태 변수
        let selectedDate = new Date(); // 사용자가 선택한 날짜 (기본 오늘)

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', async () => {
            await renderScrollableCalendar(); // 달력(가로 스크롤) 생성
            updateDateDisplay(selectedDate);  // 선택 날짜 텍스트 갱신
            await fetchReservations(formatDateDB(selectedDate)); // 테이블 데이터 조회
        });

        // --- 1. 무한 스크롤 달력 생성 함수 ---
        async function renderScrollableCalendar() {
            const container = document.getElementById('date-scroll-container');
            container.innerHTML = ''; // 초기화

            // 생성할 날짜 범위 설정 (예: 오늘부터 180일 뒤까지)
            const startDate = new Date();
            // 어제 날짜부터 보여주기 (필요시)
            startDate.setDate(startDate.getDate() - 1); 
            
            const daysToGenerate = 180; // 6개월치 생성
            const datesList = [];

            // 날짜 배열 생성
            for (let i = 0; i < daysToGenerate; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                datesList.push(day);
            }

            // Supabase에서 해당 범위의 예약 카운트 조회
            // (한 번에 180일치 카운트를 가져오거나, 필요시 나눠서 가져오지만 여기선 한 번에 조회)
            const startStr = formatDateDB(datesList[0]);
            const endStr = formatDateDB(datesList[datesList.length - 1]);

            const { data: allBookings, error } = await supabase
                .from('bookings')
                .select('check_in')
                .gte('check_in', startStr)
                .lte('check_in', endStr);
            
            // 날짜별 카운트 계산
            const counts = {};
            if (allBookings) {
                allBookings.forEach(b => {
                    counts[b.check_in] = (counts[b.check_in] || 0) + 1;
                });
            }

            // DOM 요소 생성
            datesList.forEach(date => {
                const dateStr = formatDateDB(date);
                const displayDate = `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
                const dayName = getDayName(date);
                
                const isSelected = (dateStr === formatDateDB(selectedDate));
                const isToday = (dateStr === formatDateDB(new Date()));
                const count = counts[dateStr] || 0;

                const box = document.createElement('div');
                box.className = `date-box ${isSelected ? 'active' : ''}`;
                box.id = `date-box-${dateStr}`; // ID 부여 (선택 스타일 갱신용)
                box.onclick = () => onDateClick(date); // 클릭 이벤트

                let badgeHtml = isToday ? '<div class="today-badge">오늘</div>' : '';
                // 요일 색상 (토:파랑, 일:빨강)
                let dayColor = '#333';
                if(dayName === '토') dayColor = '#0055ff';
                if(dayName === '일') dayColor = '#ff3300';

                box.innerHTML = `
                    ${badgeHtml}
                    <div class="date-text">
                        ${displayDate}<br>
                        <span style="color:${dayColor}">${dayName}</span>
                    </div>
                    <div class="count">숙박 ${count}</div>
                `;
                container.appendChild(box);
            });
        }

        // 날짜 클릭 시 실행
        async function onDateClick(clickedDate) {
            // 1. 이전에 선택된 박스의 active 클래스 제거
            const prevStr = formatDateDB(selectedDate);
            const prevBox = document.getElementById(`date-box-${prevStr}`);
            if(prevBox) prevBox.classList.remove('active');

            // 2. 새로 선택된 날짜 업데이트
            selectedDate = clickedDate;
            const newStr = formatDateDB(selectedDate);
            const newBox = document.getElementById(`date-box-${newStr}`);
            if(newBox) newBox.classList.add('active');

            // 3. 텍스트 및 테이블 업데이트
            updateDateDisplay(selectedDate);
            await fetchReservations(newStr);
        }

        // --- 2. 하단 예약 테이블 조회 기능 ---
        async function fetchReservations(targetDateStr) {
            const tableBody = document.getElementById('reservation-list');
            const summaryText = document.getElementById('table-summary-text');
            
            tableBody.innerHTML = '<tr><td colspan="9" style="padding:30px; text-align:center;">데이터를 불러오는 중입니다...</td></tr>';

            // 날짜 필터링 조회
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select(`*, rooms ( name )`)
                .eq('check_in', targetDateStr)
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                tableBody.innerHTML = '<tr><td colspan="9">데이터 로딩 실패</td></tr>';
                return;
            }

            renderTable(bookings);
        }

        function renderTable(bookings) {
            const tableBody = document.getElementById('reservation-list');
            const summaryText = document.getElementById('table-summary-text');
            tableBody.innerHTML = '';

            let totalSales = 0;
            let totalCount = bookings ? bookings.length : 0;

            if (totalCount === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="padding:40px; text-align:center; color:#888;">해당 날짜에 예약된 내역이 없습니다.</td></tr>';
                summaryText.innerText = `총 0개 | 매출액 0원`;
                return;
            }

            bookings.forEach(booking => {
                totalSales += (booking.total_price || 0);

                const roomName = booking.rooms ? booking.rooms.name : '객실정보 없음';
                const requestText = booking.guest_request || '-';
                const email = booking.guest_email || '-';
                const insta = booking.social_insta ? `@${booking.social_insta}` : '-';
                const tiktok = booking.social_tiktok ? `@${booking.social_tiktok}` : '-';
                const status = booking.status || '예약완료';

                const row = `
                    <tr>
                        <td><div class="request-text">${requestText}</div></td>
                        <td><strong>${booking.guest_name}</strong></td>
                        <td>
                            <span class="room-type">${roomName}</span>
                            <span class="stay-info">숙박</span>
                        </td>
                        <td>
                            ${booking.check_in} 15:00<br>
                            ${booking.check_out} 11:00
                        </td>
                        <td>
                            ${formatDateDisplay(booking.created_at)}<br>
                            <span style="font-size:0.8rem; color:#888;">${formatTime(booking.created_at)}</span>
                        </td>
                        <td>${status}</td>
                        <td>
                            <span class="price-final">${formatPrice(booking.total_price)}</span>
                        </td>
                        <td><input type="checkbox"> 입실완료</td>
                        <td>
                            <div class="sns-info">
                                <div class="sns-item"><i class="fa-solid fa-envelope"></i> ${email}</div>
                                <div class="sns-item"><i class="fa-brands fa-instagram"></i> ${insta}</div>
                                <div class="sns-item"><i class="fa-brands fa-tiktok"></i> ${tiktok}</div>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            summaryText.innerText = `총 ${totalCount}개 | 매출액 ${formatPrice(totalSales)}`;
        }

        // --- 유틸리티 ---
        function formatDateDB(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toTimeString().substring(0, 5);
        }

        function formatPrice(price) {
            return price ? price.toLocaleString() + '원' : '0원';
        }

        function getDayName(date) {
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            return days[date.getDay()];
        }

        function updateDateDisplay(date) {
            const dateStr = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 (${getDayName(date)})`;
            document.getElementById('selected-date-display').innerText = dateStr;
        }
    </script>
</body>
</html>
