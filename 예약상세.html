<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta 파트너센터 - 예약 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 기존 스타일 유지 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background-color: #ff6900; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .menu-list { list-style: none; margin-top: 10px; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .menu-item:hover { background-color: #e65c00; }
        .menu-item.active { background-color: #cc5200; font-weight: bold; }
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .page-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .page-desc { font-size: 0.9rem; color: #666; margin-bottom: 30px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .weekly-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .weekly-header h3 { font-size: 1rem; display: flex; align-items: center; gap: 8px; margin: 0; }
        .btn-today { font-size: 0.8rem; padding: 4px 10px; margin: 0 5px; border: 1px solid #ccc; background-color: white; border-radius: 4px; cursor: pointer; color: #333; transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; }
        .btn-today:hover { background-color: #f0f0f0; border-color: #999; color: #ff6900; }
        .date-slider-wrapper { display: flex; align-items: center; gap: 10px; }
        .nav-btn { background: white; border: 1px solid #ddd; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; transition: 0.2s; }
        .nav-btn:hover { background-color: #f0f0f0; color: #ff6900; border-color: #ff6900; }
        .date-container { display: flex; justify-content: space-between; gap: 10px; flex-grow: 1; }
        .date-box { border: 1px solid #ddd; border-radius: 4px; padding: 15px 0; flex: 1; text-align: center; cursor: pointer; position: relative; transition: all 0.2s; }
        .date-box:hover { border-color: #ffb080; }
        .date-box.active { border: 2px solid #ff6900; background-color: #fff0e6; }
        .date-box .date-text { font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; color: #333; white-space: nowrap; }
        .date-box .count { font-size: 0.9rem; color: #ff6900; font-weight: bold; }
        .today-badge { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background-color: #ff6900; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; display: none; }
        .date-box.is-today .today-badge { display: block; }
        .date-box.is-today { border-color: #ff6900; } 
        #datePickerInput { position: absolute; opacity: 0; z-index: -1; width: 1px; height: 1px; }
        .calendar-trigger { cursor: pointer; color: #666; transition: 0.2s; margin-left: 5px; font-size: 1.1rem; }
        .calendar-trigger:hover { color: #ff6900; }
        .search-filter { border: 1px solid #eee; }
        .filter-summary { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 15px; border-radius: 4px; }
        .status-tabs button { padding: 8px 16px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.9rem; margin-right: -1px; }
        .status-tabs button.active { background-color: #ff6900; color: white; border-color: #ff6900; }
        .status-tabs button:first-child { border-radius: 4px 0 0 4px; }
        .status-tabs button:last-child { border-radius: 0 4px 4px 0; }
        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .summary-text { font-size: 0.9rem; font-weight: bold; }
        
        /* 테이블 스타일 수정 */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; border-top: 2px solid #ddd; }
        .data-table th { background-color: #f5f5f5; padding: 12px 8px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; white-space: nowrap; }
        .data-table td { padding: 12px 8px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
        
        .room-type { font-weight: bold; display: block; font-size: 0.9rem; }
        .stay-info { font-size: 0.8rem; color: #ff6900; }
        .price-final { font-weight: bold; color: #333; font-size: 0.9rem; }
        .option-tag { display: inline-block; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin: 2px; color: #555; }
        
        /* SNS 아이콘 스타일 */
        .sns-icon { margin-right: 4px; font-size: 0.9rem; }
        .sns-insta { color: #E1306C; }
        .sns-tiktok { color: #000000; }
        
        /* 연락처/이메일 텍스트 작게 */
        .contact-info { font-size: 0.8rem; color: #666; display: block; margin-top: 2px; }

        .btn-action { border: 1px solid #ccc; background: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-hotel"></i> insta 파트너센터
        </div>
        <ul class="menu-list">
            <li class="menu-item"><i class="fa-solid fa-house"></i> 홈</li>
            <li class="menu-item"><i class="fa-solid fa-calendar-check"></i> 판매 관리</li>
            <li class="menu-item active"><i class="fa-solid fa-list-check"></i> 예약</li>
            <li class="menu-item"><i class="fa-solid fa-calculator"></i> 정산</li>
        </ul>
    </nav>

    <main class="main-content">
        <h1 class="page-title">예약내역 통합검색</h1>
        <p class="page-desc">예약한 고객의 예약정보를 입실 일자별 & 상세 조건별로 조회할 수 있습니다.</p>

        <div class="card weekly-status">
            <div class="weekly-header">
                <h3>
                    <i class="fa-solid fa-bullhorn"></i> 1주일 간의 입실 현황
                    <button id="todayBtn" class="btn-today">오늘</button>
                    <span id="calendarIcon" class="calendar-trigger" title="달력 열기">
                        <i class="fa-regular fa-calendar-days"></i>
                    </span>
                    <input type="date" id="datePickerInput"> 
                </h3>
            </div>
            
            <p style="font-size: 0.85rem; color:#666; margin-bottom:15px;">
                화살표를 눌러 날짜를 이동하거나 <strong>달력 아이콘</strong>을 눌러 2026년, 2027년 등 먼 날짜를 조회하세요.<br>
            </p>
            
            <div class="date-slider-wrapper">
                <button class="nav-btn" id="prevDayBtn"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="date-container" id="dynamicDateContainer"></div>
                <button class="nav-btn" id="nextDayBtn"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="card search-filter">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4><i class="fa-solid fa-magnifying-glass"></i> 예약내역 상세 검색</h4>
                <button style="border:none; background:none; cursor:pointer;">펼치기 <i class="fa-solid fa-chevron-down"></i></button>
            </div>
            
            <div class="filter-box" style="border-top:1px solid #eee; padding-top:15px;">
                <p style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;">선택된 조회 일자</p>
                <p style="font-size:0.9rem; color:#555;" id="selectedDateDisplay">날짜를 선택해주세요</p>
            </div>

            <div class="filter-summary">
                <div class="status-tabs">
                    <button class="active">입실 상태 전체</button>
                    <button>입실 전만 보기</button>
                    <button>입실 완료만 보기</button>
                </div>
            </div>

            <div style="margin-top:20px;">
                <div class="table-controls">
                    <span class="summary-text" id="tableSummary">조회 결과가 없습니다.</span>
                    <select style="padding:4px;">
                        <option>입실일 내림차순</option>
                    </select>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>요청사항</th> 
                            <th>예약자 정보</th>
                            <th>연락처 / SNS</th>
                            <th>객실 타입</th>
                            <th>옵션</th>
                            <th>입실/퇴실일시</th>
                            <th>예약일시</th>
                            <th>금액</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="bookingTableBody">
                        <tr>
                            <td colspan="9" style="padding: 30px; color: #999;">날짜를 선택하면 예약 내역이 표시됩니다.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // -----------------------------------------------------------
        // 1. Supabase 설정
        // -----------------------------------------------------------
        const supabaseUrl = 'https://eyasihczaqsacenkjhns.supabase.co';
        const supabaseKey = 'sb_publishable_Kg1O0QUrwWJzQTDCZnbhGcw_otKoMO27'; 
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // -----------------------------------------------------------
        // 2. 전역 변수
        // -----------------------------------------------------------
        const dateContainer = document.getElementById('dynamicDateContainer');
        const bookingTableBody = document.getElementById('bookingTableBody');
        const tableSummary = document.getElementById('tableSummary');
        const prevBtn = document.getElementById('prevDayBtn');
        const nextBtn = document.getElementById('nextDayBtn');
        const datePicker = document.getElementById('datePickerInput');
        const calendarIcon = document.getElementById('calendarIcon');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const todayBtn = document.getElementById('todayBtn');

        let currentStartDate = new Date();
        currentStartDate.setDate(currentStartDate.getDate() - 3);

        let selectedDate = new Date(); // 현재 선택된 날짜

        // -----------------------------------------------------------
        // 3. 유틸리티 함수
        // -----------------------------------------------------------
        function toISODateString(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatDisplayDate(date) {
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const dayName = days[date.getDay()];
            return `${yyyy}.${mm}.${dd} (${dayName})`;
        }

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('ko-KR', { 
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false 
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR').format(amount) + '원';
        }

        function isSameDate(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        // -----------------------------------------------------------
        // 4. 메인 로직: 달력 그리기 & 데이터 카운트
        // -----------------------------------------------------------
        async function renderCalendar() {
            dateContainer.innerHTML = ''; 
            const today = new Date();
            
            const rangeStart = new Date(currentStartDate);
            const rangeEnd = new Date(currentStartDate);
            rangeEnd.setDate(rangeEnd.getDate() + 6); 

            // 1) 달력 박스 생성
            for (let i = 0; i < 7; i++) {
                const renderDate = new Date(currentStartDate);
                renderDate.setDate(renderDate.getDate() + i);
                const isoDate = toISODateString(renderDate);

                const box = document.createElement('div');
                box.className = 'date-box';
                box.dataset.date = isoDate;

                if (isSameDate(renderDate, today)) box.classList.add('is-today');
                
                // 선택된 날짜 처리
                if (isSameDate(renderDate, selectedDate)) {
                    box.classList.add('active');
                    selectedDateDisplay.textContent = `선택된 입실일: ${formatDisplayDate(renderDate)}`;
                }

                const badge = isSameDate(renderDate, today) ? `<div class="today-badge">오늘</div>` : '';

                box.innerHTML = `
                    ${badge}
                    <div class="date-text">${formatDisplayDate(renderDate)}</div>
                    <div class="count" id="count-${isoDate}">숙박 -</div>
                `;

                // **날짜 박스 클릭 이벤트**
                box.addEventListener('click', () => {
                    selectedDate = new Date(renderDate);
                    renderCalendar(); // 박스 active 갱신
                    loadBookingsForDate(selectedDate); // 하단 테이블 데이터 로드
                });

                dateContainer.appendChild(box);
            }

            // 2) 카운트 데이터 가져오기
            await fetchAndDisplayCounts(rangeStart, rangeEnd);
            
            // 3) 선택된 날짜의 상세 데이터 테이블 로드 (최초 실행 시)
            loadBookingsForDate(selectedDate);
        }

        // 날짜별 예약 건수 조회
        async function fetchAndDisplayCounts(start, end) {
            const startStr = toISODateString(start);
            const endStr = toISODateString(end);

            try {
                const { data, error } = await supabase
                    .from('bookings')
                    .select('check_in')
                    .gte('check_in', startStr)
                    .lte('check_in', endStr);

                if (!error && data) {
                    const counts = {};
                    data.forEach(booking => {
                        const dateKey = booking.check_in;
                        counts[dateKey] = (counts[dateKey] || 0) + 1;
                    });

                    for (let i = 0; i < 7; i++) {
                        const targetDate = new Date(currentStartDate);
                        targetDate.setDate(targetDate.getDate() + i);
                        const isoKey = toISODateString(targetDate);
                        const countEl = document.getElementById(`count-${isoKey}`);
                        if (countEl) countEl.innerText = `숙박 ${counts[isoKey] || 0}`;
                    }
                }
            } catch (err) { console.error(err); }
        }

        // -----------------------------------------------------------
        // 5. 핵심 로직: 선택된 날짜의 예약 상세 정보 테이블 로드
        // -----------------------------------------------------------
        async function loadBookingsForDate(date) {
            const dateStr = toISODateString(date);
            
            // 로딩 표시
            bookingTableBody.innerHTML = `<tr><td colspan="9" style="padding:30px;">데이터 불러오는 중...</td></tr>`;
            
            try {
                // bookings 테이블과 rooms 테이블 조인 (room_id 이용)
                const { data, error } = await supabase
                    .from('bookings')
                    .select(`
                        *,
                        rooms ( name )
                    `)
                    .eq('check_in', dateStr)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // 데이터가 없을 경우
                if (!data || data.length === 0) {
                    bookingTableBody.innerHTML = `<tr><td colspan="9" style="padding:30px; color:#999;">${dateStr} 예약 내역이 없습니다.</td></tr>`;
                    tableSummary.innerText = `총 0개 | 매출액 0원`;
                    return;
                }

                // 데이터 렌더링
                let html = '';
                let totalSales = 0;

                data.forEach(booking => {
                    // 매출 합계 계산
                    totalSales += (booking.total_price || 0);

                    // 옵션 파싱 (JSON -> 태그)
                    let optionsHtml = '-';
                    if (booking.selected_options) {
                        try {
                            // JSONB가 객체나 배열로 올 수 있음
                            const opts = typeof booking.selected_options === 'string' 
                                ? JSON.parse(booking.selected_options) 
                                : booking.selected_options;
                            
                            // 배열이거나 객체의 키들을 나열
                            const optList = Array.isArray(opts) ? opts : Object.keys(opts);
                            optionsHtml = optList.map(opt => `<span class="option-tag">${opt}</span>`).join('');
                        } catch (e) { optionsHtml = '형식오류'; }
                    }

                    // 객실 이름 (조인된 데이터 확인)
                    const roomName = booking.rooms ? booking.rooms.name : '알수없음';
                    
                    // SNS 정보
                    let snsInfo = '';
                    if (booking.social_insta) snsInfo += `<div class="contact-info"><i class="fa-brands fa-instagram sns-icon sns-insta"></i> ${booking.social_insta}</div>`;
                    if (booking.social_tiktok) snsInfo += `<div class="contact-info"><i class="fa-brands fa-tiktok sns-icon sns-tiktok"></i> ${booking.social_tiktok}</div>`;

                    html += `
                        <tr>
                            <td style="color:#555; font-size:0.85rem; max-width:150px; word-break:keep-all;">
                                ${booking.guest_request || '-'}
                            </td>
                            <td>
                                <strong>${booking.guest_name}</strong>
                            </td>
                            <td style="text-align:left; padding-left:15px;">
                                <div><i class="fa-solid fa-phone" style="font-size:0.7rem; color:#888;"></i> ${booking.phone}</div>
                                <div class="contact-info">${booking.guest_email || '-'}</div>
                                ${snsInfo}
                            </td>
                            <td>
                                <span class="room-type">${roomName}</span>
                            </td>
                            <td style="max-width:200px; text-align:left;">
                                ${optionsHtml}
                            </td>
                            <td>
                                <span style="font-size:0.8rem; color:#666;">입실: ${booking.check_in}</span><br>
                                <span style="font-size:0.8rem; color:#666;">퇴실: ${booking.check_out}</span>
                            </td>
                            <td>
                                <span style="font-size:0.8rem; color:#888;">${formatDateTime(booking.created_at)}</span>
                            </td>
                            <td>
                                <span class="price-final">${formatCurrency(booking.total_price || 0)}</span>
                            </td>
                            <td>
                                <button class="btn-action">입실 호수 저장</button>
                            </td>
                        </tr>
                    `;
                });

                bookingTableBody.innerHTML = html;
                tableSummary.innerText = `총 ${data.length}개 | 매출액 ${formatCurrency(totalSales)}`;

            } catch (err) {
                console.error(err);
                bookingTableBody.innerHTML = `<tr><td colspan="9" style="color:red; padding:30px;">오류가 발생했습니다: ${err.message}</td></tr>`;
            }
        }

        // -----------------------------------------------------------
        // 6. 이벤트 리스너
        // -----------------------------------------------------------
        prevBtn.addEventListener('click', () => {
            currentStartDate.setDate(currentStartDate.getDate() - 1);
            renderCalendar();
        });

        nextBtn.addEventListener('click', () => {
            currentStartDate.setDate(currentStartDate.getDate() + 1);
            renderCalendar();
        });

        todayBtn.addEventListener('click', () => {
            const now = new Date();
            selectedDate = new Date(now);
            currentStartDate = new Date(now);
            currentStartDate.setDate(currentStartDate.getDate() - 3);
            renderCalendar();
        });

        calendarIcon.addEventListener('click', () => {
            try { datePicker.showPicker(); } 
            catch { datePicker.focus(); datePicker.click(); }
        });

        datePicker.addEventListener('change', (e) => {
            if(e.target.value) {
                const newDate = new Date(e.target.value);
                selectedDate = new Date(newDate);
                currentStartDate = new Date(newDate);
                currentStartDate.setDate(currentStartDate.getDate() - 3);
                renderCalendar();
            }
        });

        // 실시간 업데이트 구독 (예약 발생 시 자동 갱신)
        supabase
            .channel('public:bookings')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, () => {
                renderCalendar(); // 카운트 및 테이블 갱신
            })
            .subscribe();

        // 초기 실행
        renderCalendar();
    </script>
</body>
</html>
