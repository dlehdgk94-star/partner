<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í˜¸í…” ì¸ìŠ¤íƒ€ íŒë§¤ ìº˜ë¦°ë”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* ê¸°ë³¸ ë°°ê²½ ë° í°íŠ¸ */
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f0f2f5; }
        
        /* ìº˜ë¦°ë” ì „ì²´ í‹€ ë””ìì¸ */
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 8px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* ì€ì€í•œ ê·¸ë¦¼ì */
            max-width: 1400px; /* ë„“ê²Œ ë³´ê¸° */
            margin: 0 auto;
            min-height: 900px;
        }

        /* ìº˜ë¦°ë” í—¤ë” (ë‚ ì§œ ë¶€ë¶„) ìŠ¤íƒ€ì¼ */
        .fc-toolbar-title { font-size: 1.5em !important; font-weight: bold; color: #333; }
        .fc-col-header-cell { background-color: #fafafa; padding: 10px 0; border-bottom: 2px solid #ddd; }
        
        /* ì¼ìš”ì¼ ë¹¨ê°„ìƒ‰, í† ìš”ì¼ íŒŒë€ìƒ‰ */
        .fc-day-sun .fc-col-header-cell-cushion { color: #e53935; }
        .fc-day-sat .fc-col-header-cell-cushion { color: #1e88e5; }

        /* =========================================
           â˜… í•µì‹¬: ë‹¬ë ¥ ë‚´ë¶€ 'ë°© ì¹´ë“œ' ë””ìì¸ (ì•¼ë†€ì ìŠ¤íƒ€ì¼)
           ========================================= */
        .fc-event {
            background: none !important;
            border: none !important;
            cursor: pointer;
            margin-bottom: 4px !important;
        }

        /* ë°© ì •ë³´ë¥¼ ë‹´ëŠ” í•˜ì–€ ë°•ìŠ¤ */
        .room-card {
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .room-card:hover {
            border-color: #b0bec5;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* íŒë§¤ì¤‘/ë§ˆê° ë±ƒì§€ */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-bottom: 4px;
        }
        .badge-selling { background-color: #66bb6a; } /* íŒë§¤ì¤‘ (ì´ˆë¡) */
        .badge-soldout { background-color: #bdbdbd; } /* ë§ˆê° (íšŒìƒ‰) */
        .badge-custom { background-color: #ff9800; }  /* íŠ¹ê°€ (ì£¼í™©) */

        /* ë°© ì´ë¦„ */
        .room-name {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ë°© ê°€ê²© */
        .room-price {
            display: block;
            font-size: 12px;
            color: #555;
            text-align: right; /* ê°€ê²©ì€ ì˜¤ë¥¸ìª½ ì •ë ¬ */
        }
        
        /* ì¬ê³  í‘œì‹œ (ì‘ê²Œ) */
        .room-stock {
            font-size: 10px;
            color: #999;
            float: left;
        }

    </style>
</head>
<body>

    <h2 style="padding-left: 20px; color: #333;">íŒë§¤ ìº˜ë¦°ë”</h2>
    <p style="padding-left: 20px; color: #888; font-size: 13px; margin-bottom: 20px;">
        ìƒí’ˆì˜ íŒë§¤ ìƒíƒœ, ì¬ê³ , ê°€ê²©ì„ ë‚ ì§œë³„ë¡œ ê´€ë¦¬í•˜ì„¸ìš”. ë°©ì„ í´ë¦­í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div id='calendar'></div>

    <script>
        // ==========================================
        // 1. Supabase ì—°ê²°
        // ==========================================
        const supabaseUrl = 'https://eyasihczaqsacenklhns.supabase.co'
        const supabaseKey = 'sb_publishable_KgiOOQUrWJzQTDCZnbhGcw_otKoMO27'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 'auto',
                // ìƒë‹¨ íˆ´ë°” ë””ìì¸ (ì‹¬í”Œí•˜ê²Œ)
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next' // today ë²„íŠ¼ ëºŒ (ì‹¬í”Œí•˜ê²Œ)
                },
                titleFormat: { year: 'numeric', month: '2-digit' }, // "2025. 12" í˜•íƒœë¡œ í‘œì‹œ
                
                // [ë°ì´í„° ê°€ì ¸ì˜¤ê¸°]
                events: async function(info, successCallback, failureCallback) {
                    const { data, error } = await supabase
                        .from('inventory')
                        .select(`
                            room_id, date, price, stock, is_available, is_custom,
                            rooms ( name )
                        `)
                        .gte('date', info.startStr.split('T')[0])
                        .lte('date', info.endStr.split('T')[0]);

                    if (error) {
                        console.error('ì—ëŸ¬:', error);
                        failureCallback(error);
                        return;
                    }

                    // ë°ì´í„°ë¥¼ ì´ë²¤íŠ¸ í˜•íƒœë¡œ ë³€í™˜
                    const events = data.map(item => {
                        return {
                            title: item.rooms.name,
                            start: item.date,
                            extendedProps: {
                                room_id: item.room_id,
                                price: item.price,
                                stock: item.stock,
                                is_available: item.is_available,
                                is_custom: item.is_custom
                            }
                        }
                    });
                    successCallback(events);
                },

                // ==========================================
                // â˜… [í•µì‹¬ ë””ìì¸] ì´ë²¤íŠ¸ë¥¼ 'ì¹´ë“œ' í˜•íƒœë¡œ ê·¸ë¦¬ê¸°
                // ==========================================
                eventContent: function(arg) {
                    let props = arg.event.extendedProps;
                    let price = Number(props.price).toLocaleString(); // ê°€ê²© ì½¤ë§ˆ ì°ê¸°
                    let name = arg.event.title;

                    // 1. ìƒíƒœì— ë”°ë¥¸ ë±ƒì§€ ê²°ì • (íŒë§¤ì¤‘ vs ë§ˆê°)
                    let badgeHTML = '';
                    if (!props.is_available || props.stock <= 0) {
                        badgeHTML = `<span class="badge badge-soldout">ë§ˆê°</span>`;
                    } else if (props.is_custom) {
                        badgeHTML = `<span class="badge badge-custom">íŠ¹ê°€</span>`;
                    } else {
                        badgeHTML = `<span class="badge badge-selling">íŒë§¤ì¤‘</span>`;
                    }

                    // 2. HTML ì¡°ë¦½ (ì‚¬ì§„ê³¼ ë¹„ìŠ·í•œ êµ¬ì¡°)
                    let html = `
                        <div class="room-card">
                            <div>${badgeHTML}</div>
                            <div class="room-name">${name}</div>
                            <div style="margin-top:4px;">
                                <span class="room-stock">ì¬ê³  ${props.stock}</span>
                                <span class="room-price">${price}ì›</span>
                                <div style="clear:both;"></div>
                            </div>
                        </div>
                    `;
                    return { html: html }
                },

                // í´ë¦­ ì‹œ ìˆ˜ì • íŒì—… (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    const date = info.event.startStr;
                    const roomName = info.event.title;

                    Swal.fire({
                        title: `${date} <br> ${roomName}`,
                        html: `
                            <div style="text-align:left; font-size:14px; padding: 0 20px;">
                                <div style="margin-bottom: 10px;">
                                    <label>ğŸ’° ê°€ê²© (ì›)</label>
                                    <input id="swal-price" type="number" class="swal2-input" style="width: 100%; box-sizing: border-box;" value="${props.price}">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label>ğŸ›ï¸ ë‚¨ì€ ë°© (ê°œ)</label>
                                    <input id="swal-stock" type="number" class="swal2-input" style="width: 100%; box-sizing: border-box;" value="${props.stock}">
                                </div>
                                <div style="margin-top:15px; display: flex; align-items: center;">
                                    <input type="checkbox" id="swal-available" ${props.is_available ? 'checked' : ''} style="transform: scale(1.5); margin-right: 10px;">
                                    <label for="swal-available">ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ (ì²´í¬=ê°€ëŠ¥)</label>
                                </div>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'ì €ì¥í•˜ê¸°',
                        cancelButtonText: 'ì·¨ì†Œ',
                        confirmButtonColor: '#ff3366',
                        preConfirm: async () => {
                            const newPrice = document.getElementById('swal-price').value;
                            const newStock = document.getElementById('swal-stock').value;
                            const newAvailable = document.getElementById('swal-available').checked;

                            const { error } = await supabase
                                .from('inventory')
                                .update({ 
                                    price: newPrice,
                                    stock: newStock,
                                    is_available: newAvailable,
                                    is_custom: true
                                })
                                .eq('room_id', props.room_id)
                                .eq('date', date);

                            if (error) {
                                Swal.showValidationMessage(`ì—ëŸ¬: ${error.message}`);
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire({ title: 'ì €ì¥ ì™„ë£Œ!', icon: 'success', timer: 1000, showConfirmButton: false });
                            calendar.refetchEvents();
                        }
                    });
                }
            });

            calendar.render();
        });
    </script>

</body>
</html>
