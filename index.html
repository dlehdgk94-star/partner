<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í˜¸í…” ì¸ìŠ¤íƒ€ íŒŒíŠ¸ë„ˆì„¼í„°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f4f5f7; }
        
        /* ë‹¬ë ¥ ë””ìì¸ */
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ìº˜ë¦°ë” ì•ˆì˜ ë°© ì •ë³´ ë¸”ë¡ */
        .fc-event {
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì†ê°€ë½ í‘œì‹œ */
            border: none !important;
            margin-bottom: 2px !important;
            padding: 4px;
            border-radius: 4px;
            transition: transform 0.1s;
        }
        .fc-event:hover { transform: scale(1.02); } /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ ì»¤ì§ */

        .room-block {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        .room-name { font-weight: bold; }
        .room-price { font-weight: bold; }
        
        /* ìƒíƒœë³„ ìƒ‰ìƒ ë””ìì¸ */
        .status-available { background-color: #e8f5e9; color: #2e7d32; border-left: 3px solid #2e7d32; }
        .status-full { background-color: #ffebee; color: #c62828; border-left: 3px solid #c62828; text-decoration: line-through; }
        .status-custom { background-color: #fff3e0; color: #ef6c00; border-left: 3px solid #ef6c00; } /* íŠ¹ê°€/ìˆ˜ì •ë¨ */
    </style>
</head>
<body>

    <h1 style="text-align: center; color: #333;">ğŸ“… í˜¸í…” ì¸ìŠ¤íƒ€ íŒë§¤ ê´€ë¦¬</h1>
    <p style="text-align: center; color: #666; font-size: 14px;">ë°©ì„ í´ë¦­í•˜ë©´ ê°€ê²©ê³¼ ì¬ê³ ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    
    <div id='calendar'></div>

    <script>
        // ==========================================
        // 1. Supabase ì—°ê²° (ë„¤ í‚¤ë¡œ ë°”ê¿”ì¤˜!)
        // ==========================================
        const supabaseUrl = 'ì—¬ê¸°ì—_URL_ë¶™ì—¬ë„£ê¸°'
        const supabaseKey = 'ì—¬ê¸°ì—_ANON_KEY_ë¶™ì—¬ë„£ê¸°'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                
                // [ë°ì´í„° ê°€ì ¸ì˜¤ê¸°]
                events: async function(info, successCallback, failureCallback) {
                    const { data, error } = await supabase
                        .from('inventory')
                        .select(`
                            room_id, date, price, stock, is_available, is_custom,
                            rooms ( name )
                        `)
                        .gte('date', info.startStr.split('T')[0])
                        .lte('date', info.endStr.split('T')[0]);

                    if (error) {
                        console.error('ì—ëŸ¬:', error);
                        failureCallback(error);
                        return;
                    }

                    const events = data.map(item => {
                        let colorClass = 'status-available';
                        if (!item.is_available || item.stock <= 0) colorClass = 'status-full';
                        else if (item.is_custom) colorClass = 'status-custom';

                        return {
                            title: item.rooms.name,
                            start: item.date,
                            // í´ë¦­í–ˆì„ ë•Œ ìˆ˜ì •í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì •ë³´ë“¤ì„ ë‹¤ ë‹´ì•„ë‘ 
                            extendedProps: {
                                room_id: item.room_id, // ì¤‘ìš”! ìˆ˜ì •í•  ë•Œ ì”€
                                price: item.price,
                                stock: item.stock,
                                is_available: item.is_available,
                                is_custom: item.is_custom
                            },
                            classNames: [colorClass]
                        }
                    });
                    successCallback(events);
                },

                // [í™”ë©´ ê¾¸ë¯¸ê¸°]
                eventContent: function(arg) {
                    let price = arg.event.extendedProps.price.toLocaleString();
                    let stock = arg.event.extendedProps.stock;
                    let name = arg.event.title;
                    
                    let html = `
                        <div class="room-block">
                            <span class="room-name">${name}</span>
                            <span class="room-price">${price}ì›</span>
                        </div>
                        <div style="font-size:10px; text-align:right;">ì¬ê³ : ${stock}</div>
                    `;
                    return { html: html }
                },

                // ==========================================
                // â˜… [í•µì‹¬ ê¸°ëŠ¥] í´ë¦­í•˜ë©´ ìˆ˜ì • íŒì—… ë„ìš°ê¸°!
                // ==========================================
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    const date = info.event.startStr;
                    const roomName = info.event.title;

                    // SweetAlert2 íŒì—…ì°½ ë„ìš°ê¸°
                    Swal.fire({
                        title: `${date} <br> ${roomName}`,
                        html: `
                            <div style="text-align:left; font-size:14px;">
                                <label>ğŸ’° ê°€ê²© (ì›)</label>
                                <input id="swal-price" type="number" class="swal2-input" value="${props.price}">
                                
                                <label>ğŸ›ï¸ ë‚¨ì€ ë°© (ê°œ)</label>
                                <input id="swal-stock" type="number" class="swal2-input" value="${props.stock}">
                                
                                <div style="margin-top:15px;">
                                    <input type="checkbox" id="swal-available" ${props.is_available ? 'checked' : ''}>
                                    <label for="swal-available">ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ (ì²´í¬=ê°€ëŠ¥)</label>
                                </div>
                                <div style="margin-top:5px; color:blue;">
                                    <input type="checkbox" id="swal-custom" checked disabled>
                                    <label for="swal-custom">íŠ¹ê°€ ê³ ì • (ìë™ ì²´í¬ë¨)</label>
                                </div>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'ì €ì¥í•˜ê¸°',
                        cancelButtonText: 'ì·¨ì†Œ',
                        preConfirm: async () => {
                            // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ê°€ì ¸ì˜¤ê¸°
                            const newPrice = document.getElementById('swal-price').value;
                            const newStock = document.getElementById('swal-stock').value;
                            const newAvailable = document.getElementById('swal-available').checked;

                            // Supabaseì— ì—…ë°ì´íŠ¸ ìš”ì²­ ë³´ë‚´ê¸°!
                            const { error } = await supabase
                                .from('inventory')
                                .update({ 
                                    price: newPrice,
                                    stock: newStock,
                                    is_available: newAvailable,
                                    is_custom: true // ì§ì ‘ ìˆ˜ì •í–ˆìœ¼ë‹ˆ 'ì ê¸ˆ' ì„¤ì •!
                                })
                                .eq('room_id', props.room_id) // ì´ ë°©ì˜
                                .eq('date', date);            // ì´ ë‚ ì§œë§Œ ìˆ˜ì •í•´ë¼

                            if (error) {
                                Swal.showValidationMessage(`ì—ëŸ¬ ë°œìƒ: ${error.message}`);
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire('ì €ì¥ ì™„ë£Œ!', 'ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                            calendar.refetchEvents(); // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨ (ë°”ë€ ê°’ ë°”ë¡œ ë³´ì—¬ì£¼ê¸°)
                        }
                    });
                }
            });

            calendar.render();
        });
    </script>

</body>
</html>
