<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Insta íŒŒíŠ¸ë„ˆì„¼í„° - íŒë§¤ ê´€ë¦¬</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background-color: #f5f6f8; height: 100vh; display: flex; }
        
        .sidebar { width: 250px; background-color: #ff6900; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-area { padding: 25px 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; background-color: #ff6900; }
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-item { padding: 18px 25px; color: white; text-decoration: none; display: flex; align-items: center; transition: 0.2s; cursor: pointer; font-size: 16px; font-weight: 500; }
        .menu-item:hover { background-color: #e65c00; }
        .menu-item.active { background-color: #cc5200; font-weight: bold; border-left: none; }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; }
        
        .main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        .content-container { max-width: 1400px; margin: 0 auto; }
        
        /* í—¤ë” ì˜ì—­ (ì œëª© + í† ê¸€ ìŠ¤ìœ„ì¹˜) */
        .header-wrapper { display: flex; justify-content: space-between; align-items: end; margin-bottom: 20px; }
        .page-title { font-size: 26px; font-weight: bold; color: #333; margin: 0 0 5px 0; }
        .page-desc { color: #666; font-size: 14px; margin: 0; }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ë””ìì¸ */
        .toggle-wrapper { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #555; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ff6900; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
        #calendar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 900px; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .room-card { background-color: #fff; border: 1px solid #eee; border-radius: 4px; padding: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 2px; transition: all 0.2s; }
        .room-card:hover { border-color: #ff6900; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* â˜… í•µì‹¬: ì§€ë‚œ ë‚ ì§œ ì ‘ê¸°/í´ê¸° ìŠ¤íƒ€ì¼ â˜… */
        
        /* 1. ìº˜ë¦°ë”ê°€ 'folded' ìƒíƒœì¼ ë•Œ ì§€ë‚œ ë‚ ì§œ(past-event)ëŠ” ìˆ¨ê¹€ */
        .calendar-folded .past-event { display: none !important; }

        /* 2. ìº˜ë¦°ë”ê°€ 'folded'ê°€ ì•„ë‹ ë•Œ(ë³´ì¼ ë•Œ) ì§€ë‚œ ë‚ ì§œ ë””ìì¸ (íë¦¿í•˜ê²Œ) */
        .past-event .room-card { opacity: 0.5; background-color: #f9f9f9; border-color: #eee !important; cursor: not-allowed; }
        .past-event .room-card:hover { transform: none; box-shadow: none; }

        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; color: white; margin-bottom: 4px; }
        .badge-selling { background-color: #66bb6a; }
        .badge-soldout { background-color: #bdbdbd; }
        .badge-custom { background-color: #ff6900; }
        
        .room-name { display: block; font-size: 12px; font-weight: bold; color: #333; margin-bottom: 2px; }
        .room-info { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
        .room-price { color: #333; font-weight: bold; }
        .room-stock { color: #666; }
        
        #loading-msg { text-align: center; padding: 20px; font-size: 18px; color: #666; display: none; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo-area"><i class="fa-solid fa-hotel"></i> insta íŒŒíŠ¸ë„ˆì„¼í„°</div>
        <ul class="menu-list">
            <li class="menu-item" onclick="location.href='index.html'"><i class="fa-solid fa-house"></i> í™ˆ</li>
            <li class="menu-item active" onclick="location.href='pay.html'"><i class="fa-solid fa-calendar-check"></i> íŒë§¤ ê´€ë¦¬</li>
            <li class="menu-item" onclick="location.href='reservation.html'"><i class="fa-solid fa-list-check"></i> ì˜ˆì•½</li>
            <li class="menu-item" onclick="location.href='settlement.html'"><i class="fa-solid fa-calculator"></i> ì •ì‚°</li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="content-container">
            
            <div class="header-wrapper">
                <div>
                    <h2 class="page-title">íŒë§¤ ìº˜ë¦°ë”</h2>
                    <p class="page-desc">ìƒí’ˆì˜ íŒë§¤ ìƒíƒœ, ì¬ê³ , ê°€ê²©ì„ ë‚ ì§œë³„ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                </div>
                <div class="toggle-wrapper">
                    <span>ì§€ë‚œ ë‚ ì§œ ë³´ê¸°</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-past-events">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div id="loading-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div id='calendar' class="calendar-folded"></div>
        </div>
    </main>

    <script>
        (function() {
            // Supabase ì„¤ì •
            const supabaseUrl = 'https://eyasihczaqsacenklhns.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5YXNpaGN6YXFzYWNlbmtsaG5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjY5MTIsImV4cCI6MjA3OTk0MjkxMn0.E1J5qEgl79Ato3upXJSL0OyrgsOw6gJbNHo88AWdct0';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            let roomsCache = {};
            
            const roomPriority = { 
                'ìŠ¤íƒ ë‹¤ë“œ': 1, 
                'ë””ëŸ­ìŠ¤': 2, 
                'í”„ë¦¬ë¯¸ì—„': 3, 
                'ëŸ­ì…”ë¦¬': 4, 
                'íŠ¸ìœˆ': 5, 
                'íŠ¹ì‹¤': 6 
            };

            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                var loadingMsg = document.getElementById('loading-msg');
                var toggleBtn = document.getElementById('toggle-past-events');

                // [í† ê¸€ ê¸°ëŠ¥] ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ìº˜ë¦°ë” í´ë˜ìŠ¤ ë³€ê²½ (ì ‘ê¸°/í´ê¸°)
                toggleBtn.addEventListener('change', function() {
                    if (this.checked) {
                        calendarEl.classList.remove('calendar-folded'); // ë³´ì´ê¸°
                    } else {
                        calendarEl.classList.add('calendar-folded'); // ìˆ¨ê¸°ê¸° (ì ‘ê¸°)
                    }
                });

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    height: 'auto',
                    headerToolbar: { left: 'prev', center: 'title', right: 'next' },
                    eventOrder: 'sortIndex',

                    // [í•µì‹¬] ì§€ë‚œ ë‚ ì§œì¸ì§€ íŒë³„í•´ì„œ CSS í´ë˜ìŠ¤(past-event) ë¶™ì´ê¸°
                    eventClassNames: function(arg) {
                        let eventDate = new Date(arg.event.start);
                        let today = new Date();
                        today.setHours(0,0,0,0);

                        if (eventDate < today) {
                            return [ 'past-event' ]; // ì§€ë‚œ ë‚ ì§œë©´ ì´ í´ë˜ìŠ¤ê°€ ë¶™ìŒ
                        }
                        return [];
                    },

                    events: async function(info, successCallback, failureCallback) {
                        try {
                            loadingMsg.style.display = 'block';

                            if (Object.keys(roomsCache).length === 0) {
                                const { data: rData, error: rError } = await supabase.from('rooms').select('*');
                                if (rError) throw rError;
                                if (rData) {
                                    rData.forEach(r => { roomsCache[String(r.id)] = r; });
                                }
                            }

                            const { data: iData, error: iError } = await supabase
                                .from('inventory')
                                .select('*')
                                .gte('date', info.startStr.split('T')[0])
                                .lte('date', info.endStr.split('T')[0]);

                            if (iError) throw iError;

                            loadingMsg.style.display = 'none';

                            const events = iData
                                .filter(item => roomsCache[String(item.room_id)])
                                .map(item => {
                                    const room = roomsCache[String(item.room_id)];
                                    const sortIndex = roomPriority[room.name] || 99;
                                    
                                    return {
                                        title: room.name,
                                        start: item.date,
                                        sortIndex: sortIndex,
                                        extendedProps: {
                                            room_id: item.room_id,
                                            price: item.price,
                                            stock: item.stock,
                                            total_rooms: room.total_rooms,
                                            is_available: item.is_available,
                                            is_custom: item.is_custom
                                        }
                                    };
                                });

                            successCallback(events);

                        } catch (err) {
                            console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
                            loadingMsg.innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                            failureCallback(err);
                        }
                    },

                    eventContent: function(arg) {
                        let props = arg.event.extendedProps;
                        let price = Number(props.price).toLocaleString();
                        
                        let badgeClass = 'badge-selling';
                        let badgeText = 'íŒë§¤ì¤‘';

                        if (!props.is_available || props.stock <= 0) {
                            badgeClass = 'badge-soldout';
                            badgeText = 'ë§ˆê°';
                        } else if (props.is_custom) {
                            badgeClass = 'badge-custom';
                            badgeText = 'íŠ¹ê°€';
                        }

                        return { html: `
                            <div class="room-card">
                                <span class="badge ${badgeClass}">${badgeText}</span>
                                <div class="room-name">${arg.event.title}</div>
                                <div class="room-info">
                                    <span class="room-stock">ì¬ê³  ${props.stock}</span>
                                    <span class="room-price">${price}ì›</span>
                                </div>
                            </div>
                        `};
                    },

                    // ==========================================
                    // â˜… ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë¶€ë¶„ì…ë‹ˆë‹¤ (DB ì €ì¥ ë¡œì§) â˜…
                    // ==========================================
                    eventClick: function(info) {
                        const date = info.event.startStr;
                        let eventDate = new Date(date);
                        let today = new Date();
                        today.setHours(0, 0, 0, 0);

                        // 1. ì§€ë‚œ ë‚ ì§œ í´ë¦­ ë°©ì§€
                        if (eventDate < today) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ìˆ˜ì • ë¶ˆê°€',
                                text: 'ì§€ë‚œ ë‚ ì§œì˜ ë°ì´í„°ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                                confirmButtonColor: '#ff6900',
                                timer: 1500,
                                showConfirmButton: false
                            });
                            return;
                        }

                        const props = info.event.extendedProps;
                        const roomName = info.event.title;

                        // 2. íŒì—… ë„ìš°ê¸°
                        Swal.fire({
                            title: `<span style="font-size:18px; color:#666;">${date}</span><br><span style="font-size:24px; color:#333;">${roomName}</span>`,
                            html: `
                                <div style="text-align:left; padding: 0 10px;">
                                    <div style="margin-bottom:15px;">
                                        <label>ğŸ’° <strong>ê°€ê²©</strong> (í˜„ì¬: ${Number(props.price).toLocaleString()}ì›)</label>
                                        <input id="swal-price" type="number" class="swal2-input" value="${props.price}" style="margin-top:5px;">
                                    </div>
                                    <div style="margin-bottom:15px;">
                                        <label>ğŸ›ï¸ <strong>ì¬ê³ </strong> (ì „ì²´: ${props.total_rooms}ê°œ)</label>
                                        <input id="swal-stock" type="number" class="swal2-input" value="${props.stock}" style="margin-top:5px;">
                                    </div>
                                    <div style="display:flex; gap:20px; align-items:center; margin-top:10px;">
                                        <label style="cursor:pointer; display:flex; align-items:center;">
                                            <input type="checkbox" id="swal-available" ${props.is_available ? 'checked' : ''} style="width:18px; height:18px; margin-right:8px;"> ì˜ˆì•½ ê°€ëŠ¥
                                        </label>
                                        <label style="cursor:pointer; color:#ff6900; font-weight:bold; display:flex; align-items:center;">
                                            <input type="checkbox" id="swal-custom" ${props.is_custom ? 'checked' : ''} style="width:18px; height:18px; margin-right:8px;"> íŠ¹ê°€ ì„¤ì •
                                        </label>
                                    </div>
                                </div>
                            `,
                            showCancelButton: true,
                            confirmButtonText: 'ì €ì¥í•˜ê¸°',
                            cancelButtonText: 'ì·¨ì†Œ',
                            confirmButtonColor: '#ff6900',
                            
                            // 3. ì‹¤ì œ ì €ì¥ ë¡œì§
                            preConfirm: async () => {
                                // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (ìˆ«ì ë³€í™˜ í•„ìˆ˜!)
                                const newPrice = Number(document.getElementById('swal-price').value);
                                const newStock = Number(document.getElementById('swal-stock').value);
                                const newAvailable = document.getElementById('swal-available').checked;
                                const newIsCustom = document.getElementById('swal-custom').checked;

                                // ìœ íš¨ì„± ê²€ì‚¬
                                if (newPrice < 0 || newStock < 0) {
                                    Swal.showValidationMessage('ê°€ê²©ê³¼ ì¬ê³ ëŠ” 0ë³´ë‹¤ ì‘ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                    return false;
                                }

                                try {
                                    // Supabase Update
                                    const { data, error } = await supabase
                                        .from('inventory')
                                        .update({ 
                                            price: newPrice,         
                                            stock: newStock,         
                                            is_available: newAvailable, 
                                            is_custom: newIsCustom      
                                        })
                                        .eq('room_id', props.room_id)
                                        .eq('date', date)
                                        .select(); // ì—…ë°ì´íŠ¸ ê²°ê³¼ ë°˜í™˜ ìš”ì²­

                                    if (error) throw error;
                                    return data;

                                } catch (error) {
                                    console.error('Update Error:', error);
                                    Swal.showValidationMessage(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
                                }
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ì €ì¥ ì™„ë£Œ!',
                                    text: 'ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
                                    confirmButtonColor: '#ff6900',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
                                calendar.refetchEvents();
                            }
                        });
                    }
                });

                calendar.render();
            });
        })();
    </script>
</body>
</html>
