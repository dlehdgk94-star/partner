<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Insta íŒŒíŠ¸ë„ˆì„¼í„° - íŒë§¤ ê´€ë¦¬</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background-color: #f5f6f8; height: 100vh; display: flex; }
        
        .sidebar { width: 250px; background-color: #ff6900; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-area { padding: 25px 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; background-color: #ff6900; }
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-item { padding: 18px 25px; color: white; text-decoration: none; display: flex; align-items: center; transition: 0.2s; cursor: pointer; font-size: 16px; font-weight: 500; }
        .menu-item:hover { background-color: #e65c00; }
        .menu-item.active { background-color: #cc5200; font-weight: bold; border-left: none; }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; }
        
        .main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        .content-container { max-width: 1400px; margin: 0 auto; }
        .page-title { font-size: 26px; font-weight: bold; color: #333; margin: 0 0 10px 0; }
        .page-desc { color: #666; font-size: 14px; margin: 0 0 20px 0; }
        
        #calendar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 900px; }
        
        /* ì¹´ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .room-card { background-color: #fff; border: 1px solid #eee; border-radius: 4px; padding: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 2px; transition: all 0.2s; }
        .room-card:hover { border-color: #ff6900; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* ì§€ë‚œ ë‚ ì§œ ìŠ¤íƒ€ì¼ (íë¦¿í•˜ê²Œ) */
        .room-card.past-date { opacity: 0.5; background-color: #f9f9f9; border-color: #eee !important; cursor: not-allowed; }
        .room-card.past-date:hover { transform: none; box-shadow: none; }

        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; color: white; margin-bottom: 4px; }
        .badge-selling { background-color: #66bb6a; }
        .badge-soldout { background-color: #bdbdbd; }
        .badge-custom { background-color: #ff6900; }
        
        .room-name { display: block; font-size: 12px; font-weight: bold; color: #333; margin-bottom: 2px; }
        .room-info { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
        .room-price { color: #333; font-weight: bold; }
        .room-stock { color: #666; }
        
        #loading-msg { text-align: center; padding: 20px; font-size: 18px; color: #666; display: none; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo-area"><i class="fa-solid fa-hotel"></i> insta íŒŒíŠ¸ë„ˆì„¼í„°</div>
        <ul class="menu-list">
            <li class="menu-item" onclick="location.href='index.html'"><i class="fa-solid fa-house"></i> í™ˆ</li>
            <li class="menu-item active" onclick="location.href='pay.html'"><i class="fa-solid fa-calendar-check"></i> íŒë§¤ ê´€ë¦¬</li>
            <li class="menu-item" onclick="location.href='reservation.html'"><i class="fa-solid fa-list-check"></i> ì˜ˆì•½</li>
            <li class="menu-item" onclick="location.href='settlement.html'"><i class="fa-solid fa-calculator"></i> ì •ì‚°</li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="content-container">
            <h2 class="page-title">íŒë§¤ ìº˜ë¦°ë”</h2>
            <p class="page-desc">ìƒí’ˆì˜ íŒë§¤ ìƒíƒœ, ì¬ê³ , ê°€ê²©ì„ ë‚ ì§œë³„ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            <div id="loading-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            <div id='calendar'></div>
        </div>
    </main>

    <script>
        (function() {
            const supabaseUrl = 'https://eyasihczaqsacenklhns.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5YXNpaGN6YXFzYWNlbmtsaG5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjY5MTIsImV4cCI6MjA3OTk0MjkxMn0.E1J5qEgl79Ato3upXJSL0OyrgsOw6gJbNHo88AWdct0';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            let roomsCache = {};
            
            const roomPriority = { 
                'ìŠ¤íƒ ë‹¤ë“œ': 1, 
                'ë””ëŸ­ìŠ¤': 2, 
                'í”„ë¦¬ë¯¸ì—„': 3, 
                'ëŸ­ì…”ë¦¬': 4, 
                'íŠ¸ìœˆ': 5, 
                'íŠ¹ì‹¤': 6 
            };

            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                var loadingMsg = document.getElementById('loading-msg');

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    height: 'auto',
                    headerToolbar: { left: 'prev', center: 'title', right: 'next' },
                    eventOrder: 'sortIndex',

                    events: async function(info, successCallback, failureCallback) {
                        try {
                            loadingMsg.style.display = 'block';

                            if (Object.keys(roomsCache).length === 0) {
                                const { data: rData, error: rError } = await supabase.from('rooms').select('*');
                                if (rError) throw rError;
                                if (rData) {
                                    rData.forEach(r => { roomsCache[String(r.id)] = r; });
                                }
                            }

                            const { data: iData, error: iError } = await supabase
                                .from('inventory')
                                .select('*')
                                .gte('date', info.startStr.split('T')[0])
                                .lte('date', info.endStr.split('T')[0]);

                            if (iError) throw iError;

                            loadingMsg.style.display = 'none';

                            const events = iData
                                .filter(item => roomsCache[String(item.room_id)])
                                .map(item => {
                                    const room = roomsCache[String(item.room_id)];
                                    const sortIndex = roomPriority[room.name] || 99;
                                    
                                    return {
                                        title: room.name,
                                        start: item.date,
                                        sortIndex: sortIndex,
                                        extendedProps: {
                                            room_id: item.room_id,
                                            price: item.price,
                                            stock: item.stock,
                                            total_rooms: room.total_rooms,
                                            is_available: item.is_available,
                                            is_custom: item.is_custom
                                        }
                                    };
                                });

                            successCallback(events);

                        } catch (err) {
                            console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
                            loadingMsg.innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                            failureCallback(err);
                        }
                    },

                    // [ìˆ˜ì •ëœ ë¶€ë¶„] ì§€ë‚œ ë‚ ì§œ ë””ìì¸ ì²˜ë¦¬
                    eventContent: function(arg) {
                        let props = arg.event.extendedProps;
                        let price = Number(props.price).toLocaleString();
                        
                        // ë‚ ì§œ ë¹„êµ (ì˜¤ëŠ˜ ì´ì „ì¸ì§€ í™•ì¸)
                        let eventDate = new Date(arg.event.startStr);
                        let today = new Date();
                        today.setHours(0,0,0,0); // ì‹œê°„ì€ ë¬´ì‹œí•˜ê³  ë‚ ì§œë§Œ ë¹„êµ

                        let isPast = eventDate < today; // ì˜¤ëŠ˜ë³´ë‹¤ ì´ì „ì´ë©´ true

                        let badgeClass = 'badge-selling';
                        let badgeText = 'íŒë§¤ì¤‘';
                        let cardClass = isPast ? 'room-card past-date' : 'room-card'; // ì§€ë‚œ ë‚ ì§œë©´ í´ë˜ìŠ¤ ì¶”ê°€

                        if (!props.is_available || props.stock <= 0) {
                            badgeClass = 'badge-soldout';
                            badgeText = 'ë§ˆê°';
                        } else if (props.is_custom) {
                            badgeClass = 'badge-custom';
                            badgeText = 'íŠ¹ê°€';
                        }

                        return { html: `
                            <div class="${cardClass}">
                                <span class="badge ${badgeClass}">${badgeText}</span>
                                <div class="room-name">${arg.event.title}</div>
                                <div class="room-info">
                                    <span class="room-stock">ì¬ê³  ${props.stock}</span>
                                    <span class="room-price">${price}ì›</span>
                                </div>
                            </div>
                        `};
                    },

                    // [ìˆ˜ì •ëœ ë¶€ë¶„] ì§€ë‚œ ë‚ ì§œ í´ë¦­ ì°¨ë‹¨
                    eventClick: function(info) {
                        const date = info.event.startStr;
                        
                        // ë‚ ì§œ ë¹„êµ ë¡œì§
                        let eventDate = new Date(date);
                        let today = new Date();
                        today.setHours(0,0,0,0);

                        // [ì¤‘ìš”] ì˜¤ëŠ˜ë³´ë‹¤ ì´ì „ ë‚ ì§œë©´ ê²½ê³ ì°½ ë„ìš°ê³  í•¨ìˆ˜ ì¢…ë£Œ
                        if (eventDate < today) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ìˆ˜ì • ë¶ˆê°€',
                                text: 'ì§€ë‚œ ë‚ ì§œì˜ ì¬ê³ ì™€ ê°€ê²©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                                confirmButtonColor: '#ff6900'
                            });
                            return; // ì—¬ê¸°ì„œ ë©ˆì¶¤ (íŒì—… ì•ˆ ëœ¸)
                        }

                        // ë¯¸ë˜ ë‚ ì§œì¼ ë•Œë§Œ ì•„ë˜ ì‹¤í–‰
                        const props = info.event.extendedProps;
                        const roomName = info.event.title;

                        Swal.fire({
                            title: `${date} <br> ${roomName}`,
                            html: `
                                <div style="text-align:left; padding: 0 10px;">
                                    <div style="margin-bottom:15px;">
                                        <label>ğŸ’° <strong>ê°€ê²©</strong></label>
                                        <input id="swal-price" type="number" class="swal2-input" value="${props.price}" style="margin-top:5px;">
                                    </div>
                                    <div style="margin-bottom:15px;">
                                        <label>ğŸ›ï¸ <strong>ì¬ê³ </strong> (ì „ì²´: ${props.total_rooms}ê°œ)</label>
                                        <input id="swal-stock" type="number" class="swal2-input" value="${props.stock}" style="margin-top:5px;">
                                    </div>
                                    <div style="display:flex; gap:20px; align-items:center;">
                                        <label style="cursor:pointer;">
                                            <input type="checkbox" id="swal-available" ${props.is_available ? 'checked' : ''}> ì˜ˆì•½ ê°€ëŠ¥
                                        </label>
                                        <label style="cursor:pointer; color:#ff6900; font-weight:bold;">
                                            <input type="checkbox" id="swal-custom" ${props.is_custom ? 'checked' : ''}> íŠ¹ê°€ ì„¤ì •
                                        </label>
                                    </div>
                                </div>
                            `,
                            showCancelButton: true,
                            confirmButtonText: 'ì €ì¥í•˜ê¸°',
                            cancelButtonText: 'ì·¨ì†Œ',
                            confirmButtonColor: '#ff6900',
                            preConfirm: async () => {
                                const newPrice = document.getElementById('swal-price').value;
                                const newStock = document.getElementById('swal-stock').value;
                                const newAvailable = document.getElementById('swal-available').checked;
                                const newIsCustom = document.getElementById('swal-custom').checked;

                                const { error } = await supabase.from('inventory').update({ 
                                    price: newPrice, 
                                    stock: newStock, 
                                    is_available: newAvailable, 
                                    is_custom: newIsCustom 
                                }).eq('room_id', props.room_id).eq('date', date);

                                if (error) Swal.showValidationMessage(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire('ì €ì¥ ì™„ë£Œ!', '', 'success');
                                calendar.refetchEvents();
                            }
                        });
                    }
                });

                calendar.render();
            });
        })();
    </script>
</body>
</html>
